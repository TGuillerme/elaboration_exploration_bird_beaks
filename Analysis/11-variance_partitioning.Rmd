---
title: "Bird beak's elaboration and exploration"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

This script explores the meaning of the variance explained in big multidimensional MCMCglmm with variable sample sizes.

```{r}
library(dispRity)
library(mcmcmcglmmm)
library(dads)
```

# Variance explained in a simple model

Here I'm just doing a one dimensional model of a one dimensional trait (BM) and two clades (`"s"` and `"t"`).

```{r, echo = FALSE}
## Setting the data
set.seed(0)
data_1 <- drop.fossil.dads(dads(stop.rule = list(max.living = 20), traits = make.traits()))
data_2 <- drop.fossil.dads(dads(stop.rule = list(max.living = 20), traits = make.traits()))

## Renaming the tips and data in data_2
rownames(data_2$data)[match(data_2$tree$tip.label, rownames(data_2$data))] <- gsub("t", "s", data_2$tree$tip.label)
data_2$tree$tip.label <- gsub("t", "s", data_2$tree$tip.label)
data_1$tree$node.label <- data_2$tree$node.label <- NULL

## Combine the trees
ultrametric_tree <- chronos(multi2di(bind.tree(data_1$tree, data_2$tree)))
class(ultrametric_tree) <- "phylo"
tree <- slide.nodes(ultrametric_tree, node = 42, slide = 0.2)

## Combine the data
data <- c(data_1$data[match(data_1$tree$tip.label, rownames(data_1$data)), ], data_2$data[match(data_2$tree$tip.label, rownames(data_2$data)), ])
data <- as.data.frame(matrix(data, ncol = 1, dimnames = list(c(names(data)), c("variable"))))
data <- cbind(data, "var2" = rnorm(40), "clade" = as.factor(c(rep("t", 20), rep("s", 20))), "animal" = rownames(data))
```


We will now run it as the following model:

```
data ~ residuals + random.phylo + random.clade_s + random.clade_t
```

```{r, echo = FALSE, message = FALSE}
## Setting up the model
first_model <- make.mini.chains(data, dimensions = c(1:2), tree = tree, trait.family = "gaussian", residuals = "global", randoms = c("global", "clade"), verbose = TRUE, parameters =  list(nitt = 20000))

## running the first model
first_model_run <- run.mini.chains(first_model, replicates = 1)[[1]]
```

And this is what it looks like graphically

```{r, echo = FALSE}
## Model object
first_model_results <- MCMCglmm.subsets(
      data          = data,
      posteriors    = first_model_run,
      group         = MCMCglmm.levels(first_model_run)[c(1:3)],
      rename.groups = c("clade_s", "clade_t", "phylogeny"))

## Set the clade colours
clade_cols <- c("clade_s" = "blue", "clade_t" = "orange", "phylogeny" = "grey")

## Plotting the model
covar.plot(first_model_results, col = clade_cols, ellipses = mean, legend = TRUE)
```
We can then extract the variance of the model:

```{r, echo = FALSE}
#@ name plot.decompose.var
#@ description plotting the variance of a model in different ways
#@ param data a dispRity object
#@ param posteriors a MCMCglmm object
#@ param group.cols the colours for each term
#@ param obs.col the colour for the observed variance
#@ param relative whether to make the variance relative or absolute
#@ param plot which panels to plot. Can be any of the followings (default is all):
# "var boxplot" = variance per group;
# "var by n" = variance per sample size;
# "log var boxplot" = logged variance per group;
# "log var by n" = logged variance per sample size;
# "corrected var boxplot" = logged variance divided by logged sample sizel;
# "corrected var by n" = logged variance per logged sample size divided by logged sample size;
# "standard error" = variance per group divided by sqrt(n);
# "log standard error" = logged standard error;

plot.decompose.var <- function(data, posteriors, group.cols, obs.col = "red", relative = FALSE, plot = c("var boxplot", "var by n", "log var boxplot", "log var by n", "corrected var boxplot", "corrected var by n", "standard error", "log standard error"), ...) {
    ## Get the model variance
    model_variance <- MCMCglmm.variance(posteriors, scale = relative)
    colnames(model_variance) <- c(name.subsets(data), "residuals")
    ## Get the data variance
    if(!relative) {
        obs_var <- sd(unlist(data$matrix[[1]][, c(data$call$dimensions)]))^2
    }
    var_name <- ifelse(relative, "relative variance", "variance")
    if(missing(group.cols)) {
        group_cols <- rep("grey", ncol(model_variance))
    }
    sample_sizes <- c(size.subsets(data), "residuals" = nrow(data$matrix[[1]]))
    median_variances <- apply(model_variance, 2, median)

    ## Plotting all these with logs
    if(length(plot) > 1) {
        par(mfrow = c(ceiling(length(plot)/2), 2))
    }

    ## Overall results
    if("var boxplot" %in% plot) {
        boxplot(model_variance, main = paste0(var_name, " per terms"), xlab = var_name, col = group.cols, horizontal = TRUE, las = 1)
        if(!relative) {
            abline(v = obs_var, col = obs.col, lwd = 2)
        }
        legend("topright", legend = "data variance", col = obs.col, lty = 1, lwd = 2)
    }

    ## Results by sample size
    if("var by n" %in% plot) {
        plot(y = median_variances, x = sample_sizes, ylab = paste0("median ", var_name), xlab = "sample size", pch = 19, col =  group.cols, main = paste0(var_name, " by sample size"))
        if(!relative) {
            points(y = obs_var, x = sample_sizes[length(sample_sizes)], col = obs.col, pch = 21, cex = 2)
        }
        model <- lm(median_variances ~ sample_sizes)
        fit <- paste0("lm fit (adj.R^2) = ", round(summary(model)$adj.r.squared, 3))
        legend("topright", legend = fit, lty = 1)
    }

    ## Logged results
    if("log var boxplot" %in% plot) {
        boxplot(apply(model_variance, 2, log), main = paste0(var_name, " per terms (logged)"), xlab = paste0(var_name, "(logged)"), col = group.cols, horizontal = TRUE, las = 1)
        if(!relative) {
            abline(v = log(obs_var), col = obs.col, lwd = 2)
        }
    }

    ## Results log logged
    if("log var by n" %in% plot) {
        plot(y = log(median_variances), x = log(sample_sizes), ylab = paste0("median ", var_name, " (log)"), xlab = "sample size (log)", pch = 19, col =  group.cols, main = paste0("log ", var_name, " by sample size"))
        if(!relative) {
            points(y = log(obs_var), x = log(sample_sizes[length(sample_sizes)]), col = obs.col, pch = 21, cex = 2)
        }
        model <- lm(log(median_variances) ~ log(sample_sizes))
        abline(model$coefficients)
        fit <- paste0("lm fit (adj.R^2) = ", round(summary(model)$adj.r.squared, 3))
        legend("topright", legend = fit, lty = 1)
    }

    ## Boxplots of log logged sample size corrected results
    if("corrected var boxplot" %in% plot) {
        boxplot(apply(model_variance, 2, log)/log(sample_sizes), main = paste0(var_name, " per terms (logged)\ndivided by log(sample size)"), xlab = paste0(var_name, "(logged)/log(n)"), col = group.cols, horizontal = TRUE, las = 1)
        if(!relative) {
            abline(v = log(obs_var)/log(sample_sizes[length(sample_sizes)]), col = obs.col, lwd = 2)
        }
    }

    ## Results log logged / log sample size
    if("corrected var by n" %in% plot) {
        plot(y = log(median_variances)/log(sample_sizes), x = log(sample_sizes), ylab = paste0("median ", var_name, " (log) / log(sample size)"), xlab = "sample size (log)", pch = 19, col =  group.cols, main = paste0("corrected", var_name, " by sample size"))
        if(!relative) {
            points(y = log(obs_var)/log(sample_sizes[length(sample_sizes)]), x = log(sample_sizes[length(sample_sizes)]), col = obs.col, pch = 21, cex = 2)
        }
        model <- lm(log(median_variances)/log(sample_sizes) ~ log(sample_sizes))
        abline(model$coefficients)
        fit <- paste0("lm fit (adj.R^2) = ", round(summary(model)$adj.r.squared, 3))
        legend("topright", legend = fit, lty = 1)
    }


    ## Boxplot of standard error
    if("standard error" %in% plot) {
        boxplot(model_variance/sqrt(sample_sizes), main = "Standard error per terms", xlab = "standard error", col = group.cols, horizontal = TRUE, las = 1)
        if(!relative) {
            abline(v = obs_var/sqrt(sample_sizes[length(sample_sizes)]), col = obs.col, lwd = 2)
        }
    }

    if("log standard error" %in% plot) {
        boxplot(log(model_variance/sqrt(sample_sizes)), main = "Standard error per terms (logged)", xlab = "log standard error", col = group.cols, horizontal = TRUE, las = 1)
        if(!relative) {
            abline(v = log(obs_var/sqrt(sample_sizes[length(sample_sizes)])), col = obs.col, lwd = 2)
        }
    }
}
```

```{r, echo = FALSE}
## Plotting all the variance elements
plot.decompose.var(first_model_results, first_model_run, group.cols = c(clade_cols, "residuals" = "darkgrey"), plot = 1:8, relative = FALSE)
```

# More complex model with equal sample size

For this model we can use the charadriiformes example data from `dispRity` where the groups are slightly different sizes (but equal-ish) but based on biological data.

```{r, echo = FALSE}
data(charadriiformes)
## Same but selecting only the three first random terms
chara_data <- MCMCglmm.subsets(data       = charadriiformes$data,
                               posteriors = charadriiformes$posteriors,
                               tree       = charadriiformes$tree,
                               group      = MCMCglmm.levels(charadriiformes$posteriors)[1:4],
                               rename.groups = c("gulls", "plovers", "sandpipers", "phylogeny"))
```

This is what it looks like:

```{r, echo = FALSE}
## Set up the clade colours
clade_cols <- c("gulls" = "blue", "plovers" = "orange", "sandpipers" = "darkgreen", "phylogeny" = "grey")
## Plot the model
covar.plot(chara_data, col = clade_cols, ellipses = mean, legend = TRUE, lwd = 2, points.cex = 0.5)
```

And this is what the variances look like:

```{r, echo = FALSE}
plot.decompose.var(chara_data, charadriiformes$posteriors, group.cols = c(clade_cols, "residuals" = "darkgrey"))
```

# Model with different sample sizes

This is the big model run just on 2D and only with the super orders levels.
The differences with the true results are due to it:
 * not being the same dataset!
 * not having converged...

```{r, echo = FALSE}
## Load the models from the local files
load(file = "../Data/Cluster/shapespace_allbirds_lvl_superorder_order/chains_2D_testing/params_shapespace_2D_9levels_20k_chain1_20.rda")
model_1_20 <- shapespace_allbirds_lvl_superorder_order_2D
load(file = "../Data/Cluster/shapespace_allbirds_lvl_superorder_order/chains_2D_testing/params_shapespace_2D_9levels_20k_chain21_40.rda")
model_21_40 <- shapespace_allbirds_lvl_superorder_order_2D
load(file = "../Data/Cluster/shapespace_allbirds_lvl_superorder_order/chains_2D_testing/params_shapespace_2D_9levels_20k_chain41_60.rda")
model_41_60 <- shapespace_allbirds_lvl_superorder_order_2D
load(file = "../Data/Cluster/shapespace_allbirds_lvl_superorder_order/chains_2D_testing/params_shapespace_2D_9levels_20k_chain61_80.rda")
model_61_80 <- shapespace_allbirds_lvl_superorder_order_2D
load(file = "../Data/Cluster/shapespace_allbirds_lvl_superorder_order/chains_2D_testing/params_shapespace_2D_9levels_20k_chain81_100.rda")
model_81_100 <-shapespace_allbirds_lvl_superorder_order_2D
## Combine all the models
model <- combine.mini.chains(unlist(list(model_1_20, model_21_40, model_41_60, model_61_80, model_81_100), recursive = FALSE))

## Load the data
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.rda")
## Select the data
shapespace <- shapespace_allbirds_lvl_superorder_order[[1]]$space
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Set up the dispRity object
birds_data <- MCMCglmm.subsets(data       = shapespace[, -c(3:8)],
                               posteriors = model,
                               group      = MCMCglmm.levels(model)[-10],
                               rename.groups = c(levels(shapespace$level1)[-1], "phylogeny"))
## Set up the clade colours
load("../Data/Processed/tip_colours_super_orders.rda")
clade_cols <- c(tip_colours_super_orders, "phylogeny" = "grey")
## Plot the model
covar.plot(birds_data, col = clade_cols, ellipses = mean, legend = TRUE, lwd = 2, points.cex = 0.5)
```

```{r, echo = FALSE}
## Plotting the variance with different data
plot.decompose.var(birds_data, model, group.cols = c(clade_cols, "residuals" = "darkgrey"))
```

# Model used in this paper (8D + 32 terms)

```{r, echo = FALSE}
## Load the data
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.rda")
## Select the data
shapespace <- shapespace_allbirds_lvl_superorder_order[[1]]$space
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Load the posteriors
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.MCMCglmm")
model <- shapespace_allbirds_lvl_superorder_order[[1]]

## Get the colourss
load("../Data/Processed/tip_colours_orders.rda")
clade_cols <- c(tip_colours_super_orders, tip_colours_orders, "phylogeny" = "grey")

## Set up the dispRity object
full_model <- MCMCglmm.subsets(data       = shapespace,
                               posteriors = model,
                               group      = MCMCglmm.levels(model)[-37],
                               rename.groups = c(levels(shapespace$level1)[-1], levels(shapespace$level2)[-1], "phylogeny"))


covar.plot(full_model, col = clade_cols, ellipses = mean, legend = TRUE, lines.lty = c(rep(1, length(levels(shapespace$level1)[-1])), rep(2, length(levels(shapespace$level2)[-1])), 1), points = FALSE)
```


```{r, echo = FALSE}
## Plotting the variance with different data
plot.decompose.var(full_model, model, group.cols = c(clade_cols, "residuals" = "darkgrey"), plot = 4)
```


