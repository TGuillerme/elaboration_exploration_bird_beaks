---
title: "Ancestral traits estimations"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

```{r}
library(ape)
library(dispRity)
source("../Functions/ancestral.states.fun.R")
```

# Ancestral traits estimations

 - [ ] Run the ancestral states estimations on different trees to have a distribution rather than point estimates. Three options here to build the fuzzy trait space:
    * [ ] **Fuzzy average**: run the ace on multiple trees and use their multiple averages as the ace distribution.
    * [ ] **Random fuzzy**: run the ace on multiple trees and randomly sample one value from the estimation
    * [ ] **Fuzzy distribution**: run the ace on multiple trees and sample *n* random values from the estimation
 - [ ] Combine the data together into `dispRity` objects

## Loading the data

```{r}
load(file = "../Data/Processed/trees_list.rda")
load(file = "../Data/Processed/spaces_list.rda")
```

## Running the ancestral states

We can estimate the ancestral characters using the `ape::ace` function.
Here we define "ancestral characters" as "the position of a node of the tree in the ordinated beak shape space".
We will assume that position in shape space evolves under a Brownian Motion that is only dependent on time. I.e. the longer the evolutionary time between two elements (tips or nodes), the more variance there is in position in shape space.

> Note that this is not the only assumption we can make. One other correct one would be to scale the branch length by amount of changes (cf. by evolutionary time). This way, the longer the branch (the longer the molecular changes) between two elements, the more variance.

We will also assume that the position in the trait space are independent (i.e. position on the first axis of the trait space is not related to the position on the second axis, etc...).

> This assumption can also be relaxed pretty easily using a multi trait BM. However, it is rather defendable to not do here since the ordination by definition makes the axis orthogonal and thus non-correlated.

From each ancestral character estimation, we will extract either:
 * [ ] the character value with the highest likelihood
 * [ ] one random character value from within the 95% confidence interval
 * [ ] ten random character values from the 95% CI

```{r, eval = FALSE}
## Running the ace for all the characters for both spaces
psita_ace <- lapply(trees_list$psittaciformes, run.full.ace,
                    matrix = spaces_list$psittaciformes)
chara_ace <- lapply(trees_list$charadriiformes, run.full.ace,
                    matrix = spaces_list$charadriiformes)
save(psita_ace, file = "../Data/Processed/psita_ace.rda")
save(chara_ace, file = "../Data/Processed/chara_ace.rda")
```

> TODO: improve the ACE speed exploring castor::asr_independent_contrasts, castor::asr_squared_change_parsimony or castor::asr_subtree_averaging


### Extracting the ancestral estimates

Here we will select the ancestral traits estimations two ways:
 * First by selecting the most likely estimations (i.e. highest lik log) for each node;
 * Second by randomly sampling 10 values using a normal distribution around the 95% estimation interval (mean = mean(ci95); sd = diff(ci95)/4; the diff(ci95) is because there are roughly 4 standard deviations in the 95% range of a normal distribution).

```{r}
## Loading the precaculated results
load("../Data/Processed/psita_ace.rda")
load("../Data/Processed/chara_ace.rda")

## Building the matrices
psita_max_ace <- lapply(psita_ace, extract.ace, what = "max",
                         matrix = spaces_list$psittaciformes)
psita_10n_ace <- lapply(psita_ace, extract.ace, what = 10, sampling = "normal",
                         matrix = spaces_list$psittaciformes)
chara_max_ace <- lapply(chara_ace, extract.ace, what = "max",
                         matrix = spaces_list$charadriiformes)
chara_10n_ace <- lapply(chara_ace, extract.ace, what = 10, sampling = "normal",
                         matrix = spaces_list$charadriiformes)
```

## Make the dispRity objects

> TODO: add the trees to these matrices for the next dispRitree package!


```{r}
## TEMPORARY analyses: one matrix, one ace and one tree:
tmp_simple_matrices <- list(
    "psita" = make.dispRity(data = psita_max_ace[[1]], tree = trees_list$psittaciformes[[1]]),
    "chara" = make.dispRity(data = chara_max_ace[[1]], tree = trees_list$charadriiformes[[1]]))
save(tmp_simple_matrices, file = "../Data/Processed/tmp_simple_matrices.rda")
```


```{r}
## Converting the lists into dispRity objects
disparity_matrices <- list(
    "psita_max" = make.dispRity(data = psita_max_ace),
    "psita_10n" = make.dispRity(data = unlist(psita_10n_ace, recursive = FALSE)),
    "chara_max" = make.dispRity(data = chara_max_ace),
    "chara_10n" = make.dispRity(data = unlist(chara_10n_ace, recursive = FALSE)))
save(disparity_matrices, file = "../Data/Processed/disparity_matrices.rda")
```

## Visualisation

```{r, fig.height = 18, fig.width = 12}
par(mfrow = c(3, 2))

##Â Loading the full space
plot.dispRity(spaces_list$psittaciformes, col = "blue", main = "Psittaciformes section of the shape space", xlab = "PC1", ylab = "PC2")
plot.dispRity(spaces_list$charadriiformes, col = "orange", main = "Charadriiformes section of the shape space", xlab = "PC1", ylab = "PC2")

## Full space with max ancestor
plot(custom.subsets(psita_max_ace[[1]], group = list("Nodes" = 342:681, "Tips" = 1:341)), col = c("grey", "blue"), pch = c(19, 19), main = "Psittaciformes with nodes (max. lik.; tree 1)", xlab = "PC1", ylab = "PC2")
plot(custom.subsets(chara_max_ace[[1]], group = list("Nodes" = 360:717, "Tips" = 1:359)), col = c("grey", "orange"), pch = c(19, 19), main = "Charadriiformes with nodes (max. lik.; tree 1)", xlab = "PC1", ylab = "PC2")

## Full space with random ancestor
plot(custom.subsets(psita_10n_ace[[1]], group = list("Nodes" = 342:681, "Tips" = 1:341)), col = c("grey", "blue"), pch = c(19, 19), main = "Psittaciformes with nodes (random; tree 1)", xlab = "PC1", ylab = "PC2")
plot(custom.subsets(chara_10n_ace[[1]], group = list("Nodes" = 360:717, "Tips" = 1:359)), col = c("grey", "orange"), pch = c(19, 19), main = "Charadriiformes with nodes (random; tree 1)", xlab = "PC1", ylab = "PC2")
```
