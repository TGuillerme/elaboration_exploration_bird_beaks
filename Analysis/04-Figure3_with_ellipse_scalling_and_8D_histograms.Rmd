---
title: "Bird beak's elaboration and innovation"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

This section contains the code for reproducing the analyses. To get the details, refer to 03-elaboration_innovation_analyses.Rmd.

```{r, eval = TRUE, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE, print = FALSE}
library(dispRity)
source("../Functions/ploting.utilities.R")
source("../Functions/covar.utilities.R")
```

# All birds shapespace analyses

```{r, eval = TRUE, echo = FALSE}
## Load the data
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.rda")
## Select the data
shapespace <- shapespace_allbirds_lvl_superorder_order[[1]]$space
tree <- shapespace_allbirds_lvl_superorder_order[[1]]$consensus_tree
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Load the covar
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.MCMCglmm")
shapespace_allbirds_lvl_superorder_order <- shapespace_allbirds_lvl_superorder_order[[1]]

## Get the levels
phylo_lvl <- which(MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order) == "animal")
super_lvl <- grep("level1_", MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order))
order_lvl <- grep("level2_", MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order))

## Creating the subsets
superorder_shapespace <- MCMCglmm.subsets(n = 4000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_allbirds_lvl_superorder_order,
      group         = MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order)[c(super_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level1)[-1], "phylogeny")) #[-1] is because the first level is ""

order_shapespace <- MCMCglmm.subsets(n = 4000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_allbirds_lvl_superorder_order,
      group         = MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order)[c(order_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level2)[-1], "phylogeny")) #[-1] is because the first level is ""
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Loading the results
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order_results_list_4k.rda")
results <- shapespace_allbirds_lvl_superorder_order_results_list
rm(shapespace_allbirds_lvl_superorder_order_results_list)
```

```{r, eval = TRUE, echo = FALSE}
box_size <- 1.5
pdf(file = "../Manuscript/Figures/Figure3_ellipses_2.pdf", height = box_size*8, width = box_size*10)

## SETTING THE WINDOW PARAMETERS

## Global window parameters
lay_mat_order <- rbind(
        matrix(c(1,1, 2:9), ncol = 10, nrow = 1), # line 1
        matrix(c(1,1, 10:17), ncol = 10, nrow = 1), # line 2
        matrix(c(57,58, 18:25), ncol = 10, nrow = 1), # line 3
        matrix(c(26:35), ncol = 10, nrow = 1), # line 4
        matrix(c(36:45), ncol = 10, nrow = 1), # line 5
        matrix(c(46:55), ncol = 10, nrow = 1) # line 6
    )
lay_mat_super <- rbind(
        matrix(c(1,1, 2:9), ncol = 10, nrow = 1), # line 7
        matrix(c(73,0, 10:17), ncol = 10, nrow = 1) # line 8
    )
heights_vals <- rep(1, 9)
widths_vals <- rep(c(1, 1/3), 5)
layout_matrix <- layout(rbind(lay_mat_super, (lay_mat_order+17)), widths = widths_vals, heights = heights_vals, respect = TRUE)

## PLOTTING THE SUPERORDERS

## Getting the tip order for the ladderised super order tree
tip_order <- c(
    "Paleognathae" = 1,
    "Galloanserae" = 2,
    "Otidimorphae" = 5,
    "Aequornithes" = 6,
    "Mirandornithes" = 3,
    "Columbimorphae" = 4,
    "Telluraves" = 8,
    "Strisores" = 7)

## Plotting the tree and getting the tip orders
tip_colours_super_orders <- plot.short.tree(tree, shapespace, "level1", tip.order = tip_order)
save(tip_colours_super_orders, file = "../Data/Processed/tip_colours_super_orders.rda")

## Plotting the ellipses
for(i in 1:length(tip_order)) {
    ## Plot each pannel
    wrap.plot.ellipses(i, tip_colours_super_orders, superorder_shapespace, results$super_results_between)
}

## Matching colours (fast utility)
match.col <- function(data, col) {
    return(c(col[match(names(size.subsets(data)), names(col))[-length(size.subsets(data))]], "grey"))
}

## Matching the order and the colours to the ladderised tree
tip_order <- c(
    "Tinamiformes"= 1,
    "Galliformes"= 3,
    "Anseriformes"= 2,
    "Otidiformes"= 7,
    "Cuculiformes" = 8,
    "Gruiformes" = 9, 
    "Musophagiformes" = 10,
    "Procellariiformes" = 12,
    "Sphenisciformes" = 11,
    "Ciconiiformes" = 13,
    "Pelecaniformes"= 15,
    "Suliformes" = 14,
    "Podicipediformes" = 4,
    "Columbiformes" = 6,
    "Pterocliformes" = 5,
    "Charadriiformes" = 18,
    "Trogoniformes" = 21,
    "Bucerotiformes" = 22,
    "Coraciiformes" = 23,
    "Piciformes" = 24,
    "Strigiformes" = 20,
    "Accipitriformes" = 19, 
    "Falconiformes" = 25,
    "Psittaciformes" = 26,
    "Passeriformes" = 27,
    "Caprimulgiformes" = 16, 
    "Apodiformes" = 17)

## Plotting the tree and getting the tip orders
tip_colours_orders <- plot.short.tree(tree, shapespace, "level2", tip.order = tip_order)
save(tip_colours_orders, file = "../Data/Processed/tip_colours_orders.rda")

## Plotting the ellipses
for(i in 1:length(tip_order)) {
    ## Plot each pannel
    wrap.plot.ellipses(i, tip_colours_orders, order_shapespace, results$order_results_between)
}


## Plotting the aligned and scale ellipses for the superorders
par(bty = "n")
lims <- c(-1/3, 1/3) # c(-1.25, 1.25)
plot(NULL, xlim = lims, ylim = lims, xaxt = "n", yaxt = "n", xlab = "n", ylab = "n")
abline(v = 0, col = "grey", lwd = 0.5)
abline(h = 0, col = "grey", lwd = 0.5)
covar.plot(superorder_shapespace, ellipses = mean,
           col = match.col(superorder_shapespace, tip_colours_super_orders),
           legend = FALSE, points = FALSE, scale = "phylogeny",
           lines.lwd = c(rep(1, length(tip_colours_super_orders)), 3),
           add = TRUE, n = 50)

## PLOTTING THE ORDERS

load("../Data/Processed/tip_colours_orders.rda")
par(bty = "n")
lims <- c(-1/3, 1/3) # c(-1.25, 1.25)
plot(NULL, xlim = lims, ylim = lims, xaxt = "n", yaxt = "n", xlab = "n", ylab = "n")
abline(v = 0, col = "grey", lwd = 0.5)
abline(h = 0, col = "grey", lwd = 0.5)
covar.plot(order_shapespace, ellipses = mean,
           col = match.col(order_shapespace, tip_colours_orders),
           legend = FALSE, points = FALSE, scale = "phylogeny",
           lines.lwd = c(rep(0.5, length(tip_colours_orders)), 3),
           add = TRUE, n =50)

dev.off()

```


## Overlapping ellipses plot

```{r}
load("../Data/Processed/tip_colours_super_orders.rda")
load("../Data/Processed/tip_colours_orders.rda")

## Matching colours (fast utility)
match.col <- function(data, col) {
    return(c(col[match(names(size.subsets(data)), names(col))[-length(size.subsets(data))]], "grey"))
}

pdf(file = "../Manuscript/Figures/Figure_supplementary_aligned_ellipses.pdf", height = 6, width = 12)
par(mfrow = c(1,2))
## Plotting the aligned and scale ellipses for the superorders
covar.plot(superorder_shapespace, ellipses = mean,
           col = match.col(superorder_shapespace, tip_colours_super_orders),
           legend = TRUE, points = FALSE, scale = "phylogeny",
           lines.lwd = c(rep(1, length(tip_colours_super_orders)), 3),
           main = "Scaled and centred average super order VCV")

## Plotting the aligned and scale ellipses for the superorders
covar.plot(order_shapespace, ellipses = mean,
           col = match.col(order_shapespace, tip_colours_orders),
           legend = FALSE, points = FALSE, scale = "phylogeny",
           lines.lwd = c(rep(0.5, length(tip_colours_orders)), 3),
           main = "Scaled and centred average order VCV")
dev.off()
```



# Passeriformes shapespace analyses

```{r, eval = TRUE, echo = FALSE}
## Load the data
load(file = "../Data/Processed/shapespace_passeriformes_two_levels.rda")
## Select the data
shapespace <- shapespace_passeriformes_two_levels[[1]]$space
tree <- shapespace_passeriformes_two_levels[[1]]$consensus_tree
## Clean garbage
rm(shapespace_passeriformes_two_levels)

## Load the covar
load(file = "../Data/Processed/shapespace_passeriformes.MCMCglmm")
shapespace_passeriformes <- shapespace_passeriformes[[1]]

## Get the levels
phylo_lvl <- which(MCMCglmm.levels(shapespace_passeriformes) == "animal")
suborder_lvl <- grep("level1_", MCMCglmm.levels(shapespace_passeriformes))
family_lvl <- grep("level2_", MCMCglmm.levels(shapespace_passeriformes))

## Creating the subsets
suborder_shapespace <- MCMCglmm.subsets(#n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_passeriformes,
      group         = MCMCglmm.levels(shapespace_passeriformes)[c(suborder_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level1)[-1], "phylogeny")) #[-1] is because the first level is ""

family_shapespace <- MCMCglmm.subsets(#n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_passeriformes,
      group         = MCMCglmm.levels(shapespace_passeriformes)[c(family_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level2)[-1], "phylogeny")) #[-1] is because the first level is ""
## Clean garbage
rm(shapespace_passeriformes)

## Loading the results
load(file = "../Data/Processed/shapespace_passeriformes_suborder_family_results_list.rda")
results <- shapespace_passeriformes_suborder_family_results_list
rm(shapespace_passeriformes_suborder_family_results_list)
```

## Phylogeny window (detailed)

```{r}
box_size <- 1.5
pdf(file = "../Manuscript/Figures/Figure3_passeriformes.pdf", height = box_size*7, width = box_size*10)

## Global window
lay_mat_family <- rbind(
        matrix(c(1,1, 2:9), ncol = 10, nrow = 1), # line 1
        matrix(c(1,1, 10:17), ncol = 10, nrow = 1), # line 2
        matrix(c(1,1, 18:25), ncol = 10, nrow = 1), # line 3
        matrix(c(26:35), ncol = 10, nrow = 1), # line 4
        matrix(c(36:45), ncol = 10, nrow = 1), # line 5
        matrix(c(46:47, rep(-13,8)), ncol = 10, nrow = 1) # line 6
    )
lay_mat_sub <- rbind(
        matrix(c(1,1, 2:9, c(1,1), 10:13, rep(0, 4)), ncol = 10, nrow = 2, byrow = TRUE) # line 7
    )
heights_vals <- rep(1, 8)
widths_vals <- rep(c(1, 1/3), 5)
layout_matrix <- layout(rbind(lay_mat_sub, (lay_mat_family+13)), widths = widths_vals, heights = heights_vals, respect = TRUE)
# layout.show(layout_matrix)

## PLOTTING THE SUBORDERS

## Getting the tip order for the ladderised super order tree
tip_order <- c(
    "Suboscines" = 1,
    "Meliphagoidea" = 2,
    "Corvides" = 3,
    "Sylviida" = 4,
    "Muscicapida" = 5,
    "Passerida" = 6)

## Plotting the tree and getting the tip orders
tip_colours_passeriformes_level1 <- plot.short.tree(tree, shapespace, "level1", tip.order = tip_order)
save(tip_colours_passeriformes_level1, file = "../Data/Processed/tip_colours_passeriformes_level1.rda")

## Plotting the ellipses
for(i in 1:length(tip_order)) {
    ## Plot each pannel
    wrap.plot.ellipses(i, tip_colours_passeriformes_level1, suborder_shapespace, results$suborder_results_between)
}

## PLOTTING THE FAMILIES

## Matching the order and the colours to the ladderised tree
tip_order <- c(
    "Aegithaloidea"= 12,
    "Bombycilloidea"= 17,
    "Cisticolidae"= 14,
    "Corvoidea"= 7,
    "Emberizoidea"= 23,
    "Eurylaimides"= 1,
    "Fringillidae"= 10,
    "Furnariida"= 3,
    "Hirundinidae"= 11,
    "Locustelloidea"= 15,
    "Malaconotoidea"= 5,
    "Meliphagoidea"= 4,
    "Motacillidae"= 22,
    "Muscicapoidea"= 18,
    "Nectariniidae"= 19,
    "Orioloidea"= 6,
    "Paridae"= 9,
    "Passeridae"= 21,
    "Petroicidae"= 8,
    "PloceidaeEstrildidae"= 20,
    "Pycnonotidae"= 13,
    "Sylvioidea"= 16,
    "Tyrannida" = 2)

## Plotting the tree and getting the tip orders
tip_colours_passeriformes_level2 <- plot.short.tree(tree, shapespace, "level2", tip.order = tip_order)
save(tip_colours_passeriformes_level2, file = "../Data/Processed/tip_colours_passeriformes_level2.rda")

## Plotting the ellipses
for(i in 1:length(tip_order)) {
    ## Plot each pannel
    wrap.plot.ellipses(i, tip_colours_passeriformes_level2, family_shapespace, results$family_results_between)
}
dev.off()

```
