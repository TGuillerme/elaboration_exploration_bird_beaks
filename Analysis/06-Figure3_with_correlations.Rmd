---
title: "Bird beak's elaboration and innovation"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

This section contains the code for reproducing the analyses. To get the details, refer to 03-elaboration_innovation_analyses.Rmd.

```{r, eval = TRUE, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE, print = FALSE}
library(dispRity)
source("../Functions/ploting.utilities.R")
source("../Functions/correlations.utilities.R")
```

# All birds shapespace analyses

```{r, eval = TRUE, echo = FALSE}
## Load the data
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.rda")
## Select the data
shapespace <- shapespace_allbirds_lvl_superorder_order[[1]]$space
tree <- shapespace_allbirds_lvl_superorder_order[[1]]$consensus_tree
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Load the covar
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.MCMCglmm")
shapespace_allbirds_lvl_superorder_order <- shapespace_allbirds_lvl_superorder_order[[1]]

## Get the levels
phylo_lvl <- which(MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order) == "animal")
super_lvl <- grep("level1_", MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order))
order_lvl <- grep("level2_", MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order))

## Creating the subsets
superorder_shapespace <- MCMCglmm.subsets(n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_allbirds_lvl_superorder_order,
      group         = MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order)[c(super_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level1)[-1], "phylogeny")) #[-1] is because the first level is ""

order_shapespace <- MCMCglmm.subsets(n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_allbirds_lvl_superorder_order,
      group         = MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order)[c(order_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level2)[-1], "phylogeny")) #[-1] is because the first level is ""
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Loading the projection/rejections results
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order_results_list.rda")
results <- shapespace_allbirds_lvl_superorder_order_results_list
rm(shapespace_allbirds_lvl_superorder_order_results_list)
```

Extract the median correlations from the results (for the groups ion the phylogeny and the groups on themselves)

```{r, eval = TRUE, echo = FALSE}
## Calculate the correlations for the projections onto the phylo axis
super_phylo_cor <- get.correlations(results$super_results_phylo)

## Calculate the correlations for the projections onto the group' axes
super_group_cor <- get.correlations(results$super_results_within, exclude.phylo = TRUE)
```

### Figure b): the overall density plot

Density plot of the correlation of the median elaboration and median exploration for all species.

```{r, echo = FALSE, eval = FALSE}
pdf("../Manuscript/Figures/Figure3_b.pdf", height = 4.5, width = 4)

## Plotting the densities with the quadrant
par(mar = c(5, 4, 4, 2) + 0.1)
plot.densities(super_phylo_cor$phylogeny, with.quadrant = TRUE)

dev.off()
```

### Figure a): explanations

This might have to be removed.

```{r, echo = FALSE, eval = FALSE}
pdf("../Manuscript/Figures/Figure3_a.pdf", height = 6, width = 3)
## Plotting the projection cartoon
library(mcmcmcglmmm)
## Get projection lines (from a centred matrix)
get.proj.line <- function(point, base) {
  point <- t(point)
  base <- t(base)
  proj_x <- ( (point[1]*base[1] + point[2]*base[2]) / (base[1]*base[1] + base[2]*base[2]) ) * base[1];
  proj_y <- ( (point[1]*base[1] + point[2]*base[2]) / (base[1]*base[1] + base[2]*base[2]) ) * base[2];
  return(rbind(cbind(proj_x, proj_y), point))
}

set.seed(42)
## Space plot
cor_matrix <- matrix(cbind(1, 0.8, 0.8, 1), nrow = 2)
space <- space.maker(10, 2, rnorm, cor.matrix = cor_matrix)
lim <- c(floor(range(space)[1]), ceiling(range(space)[2]))

par(mfrow = c(2, 1))
## Projections per species
## Translate the major axis
par(bty = "n", mar = c(1,1,1,1)+0.1)
plot(space, pch = 19, xlab = "", ylab = "", xlim = lim, ylim = lim, col = "grey", main = "Panels B and C: species'\nprojection on the phylogeny", xaxt = "n", yaxt = "n")
abline(v = 0, col = "grey", lwd = 0.5)
abline(h = 0, col = "grey", lwd = 0.5)
## Plotting the ellipse
lines(ellipse::ellipse(cor_matrix, level = 0.75), col = "grey", lwd = 1)
## Plotting the major axis
lines(get.one.axis(list(VCV = cor_matrix, Sol = c(0,0)), level = 0.75), lwd = 3, col = "grey", lty = 1)
lines(x = c(-1.2, 2), y = c(0, 0.75), lwd = 3, col = "orange")
# legend("bottomright", legend = "C")

## Do the projection
matrix <- space
point1 <- c(-1.2, 0)
point2 <- c(2, 0.75)
base_vector <- rbind(point1, point2)

## Get all the space (with the two last rows being the base vectors)
space_cent <- rbind(matrix, base_vector)
## Centre all the space
space_cent <- space_cent - rep(point1, rep.int(nrow(space_cent), ncol(space_cent)))
## Re-attribute the centred variables
matrix_cent <- space_cent[1:nrow(matrix), ]
base_vector_cent <- space_cent[-c(1:nrow(matrix)), ]

## Plot the projections
for(i in 1:nrow(matrix)) {
  cent_proj <- get.proj.line(matrix_cent[i,], base_vector_cent[2, ])
  cent_proj[, 1] <- (cent_proj[, 1] + point1[1])
  lines(cent_proj, col = "darkgreen")
}



## Species projection onto their own axis
par(bty = "n", mar = c(1,1,1,1)+0.1)
plot(space, pch = 19, xlab = "", ylab = "", xlim = lim, ylim = lim, col = "grey", main = "Panels D: species'\nprojection on their own group", xaxt = "n", yaxt = "n")
abline(v = 0, col = "grey", lwd = 0.5)
abline(h = 0, col = "grey", lwd = 0.5)
lines(x = c(-1.2, 2), y = c(0, 0.75), lwd = 3, col = "grey")
## Plotting the ellipse
lines(ellipse::ellipse(cor_matrix, level = 0.75), col = "blue", lwd = 1)
## Plotting the major axis
lines(get.one.axis(list(VCV = cor_matrix, Sol = c(0,0)), level = 0.75), lwd = 3, col = "blue", lty = 1)
# legend("bottomright", legend = "D")

## Do the projection
matrix <- space
base_vector <- get.one.axis(list(VCV = cor_matrix, Sol = c(0,0)), level = 0.75)
point1 <- base_vector[1,]
point2 <- base_vector[2,]

## Get all the space (with the two last rows being the base vectors)
space_cent <- rbind(matrix, base_vector)
## Centre all the space
space_cent <- space_cent - rep(point1, rep.int(nrow(space_cent), ncol(space_cent)))
## Re-attribute the centred variables
matrix_cent <- space_cent[1:nrow(matrix), ]
base_vector_cent <- space_cent[-c(1:nrow(matrix)), ]
## Extend the base vector a little bit
extend_base <- base_vector
extend_base[1, ] <- extend_base[1,1] + 0.05
lines(extend_base, lwd = 1, col = "blue", lty = 2)

## Plot the projections
for(i in 1:nrow(matrix_cent)) {
  cent_proj <- get.proj.line(matrix_cent[i,], base_vector_cent[2, ])
  cent_proj[, 1] <- (cent_proj[, 1] + point1[1])
  cent_proj[, 2] <- (cent_proj[, 2] + point1[2])
  lines(cent_proj, col = "darkgreen")
}
dev.off()
```

## Figure c) and d): the correlation plots for each group

```{r, echo = FALSE, eval = FALSE}
## Loading the distances from centre for each species (if adding outlines)
load("../Data/Processed/ploting_data.rda")
centroids <- ploting_data$distances_to_centre[[1]]

## Setting the colour pallette
colour.palette <- gg.color.hue

pdf("../Manuscript/Figures/Figure3_cd.pdf", height = 12, width = 8)

## Make the plot layout
layout_matrix <- cbind(matrix(0,2,2), matrix(0,2,2))
layout_matrix <- rbind(rbind(layout_matrix, matrix(1:8, 2, 4, byrow = TRUE)), matrix(9:16, 2, 4,  byrow = TRUE))
plot_layout <- layout(layout_matrix)
# layout.show(plot_layout)

## Getting the subsets for the colouring
col_subs <- c(split(shapespace$level2, f = shapespace$level1)[-1], "phylogeny" = list(shapespace$level1))

## Set the vector of legend positions
legends_pos <- c("topleft", "topright", "topright", "topright",
                 "topleft", "topright", "topleft", "topright")
## Creat the vector for counting the legend numbers
legend_counter <- 1

for(i in 1:8) {
    par(mar = c(2,2.5,2,1.5))
    plot.correlations(super_phylo_cor[[i]], col.sub = col_subs[[i]], legend.pos = legends_pos[i], ID = i, pt.cex = 0.5, legend.cex = 2/3, legend_counter = legend_counter, contour = NULL, with.quadrant = FALSE)
}


## Fig 3c

# par(mfrow = c(2, 4))
## Getting the subsets for the colouring
col_subs <- c(split(shapespace$level2, f = shapespace$level1)[-1], "phylogeny" = list(shapespace$level1))

## Set the vector of legend positions
legends_pos <- c("bottomright", "topright", "topleft", "topleft",
                 "topleft", "topleft", "topright", "bottomright")
legend_counter <- 1

for(i in 1:8) {
    par(mar = c(2,2.5,2,1.5))
    plot.correlations(super_group_cor[[i]], col.sub = col_subs[[i]], legend.pos = legends_pos[i], ID = i, pt.cex = 0.5, legend.cex = 2/3, legend_counter = legend_counter, with.quadrant = FALSE, contour = NULL)
}
dev.off()
```


# Correlations for passeriformes

```{r, eval = TRUE, echo = FALSE}
## Load the data
load(file = "../Data/Processed/shapsepace_passeriformes_suborder_family.rda")
## Select the data
shapespace <- shapsepace_passeriformes_suborder_family[[1]]$space
tree <- shapsepace_passeriformes_suborder_family[[1]]$consensus_tree
## Clean garbage
rm(shapsepace_passeriformes_suborder_family)

## Load the covar
load(file = "../Data/Processed/shapespace_passeriformes.MCMCglmm")
shapespace_passeriformes <- shapespace_passeriformes[[1]]

## Get the levels
phylo_lvl <- which(MCMCglmm.levels(shapespace_passeriformes) == "animal")
subor_lvl <- grep("level1_", MCMCglmm.levels(shapespace_passeriformes))
famil_lvl <- grep("level2_", MCMCglmm.levels(shapespace_passeriformes))

## Creating the subsets
suborder_shapespace <- MCMCglmm.subsets(n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_passeriformes,
      group         = MCMCglmm.levels(shapespace_passeriformes)[c(subor_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level1)[-1], "phylogeny")) #[-1] is because the first level is ""

family_shapespace <- MCMCglmm.subsets(n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_passeriformes,
      group         = MCMCglmm.levels(shapespace_passeriformes)[c(famil_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level2)[-1], "phylogeny")) #[-1] is because the first level is ""
## Clean garbage
rm(shapespace_passeriformes)

## Loading the results
load(file = "../Data/Processed/shapespace_passeriformes_suborder_family_results_list.rda")
results <- shapespace_passeriformes_suborder_family_results_list
rm(shapespace_passeriformes_suborder_family_results_list)
```

```{r, eval = TRUE, echo = FALSE}
## Calculate the correlations for the projections onto the phylo axis
suborder_phylo_cor <- get.correlations(results$suborder_results_phylo)

## Calculate the correlations for the projections onto the group' axes
suborder_group_cor <- get.correlations(results$suborder_results_within, exclude.phylo = TRUE)
```


```{r, echo = FALSE, eval = FALSE}
pdf("../Manuscript/Figures/Figure3_b.pdf", height = 4.5, width = 4)

## Plotting the densities with the quadrant
par(mar = c(5, 4, 4, 2) + 0.1)
plot.densities(suborder_phylo_cor$phylogeny, with.quadrant = TRUE)

dev.off()
```






## Figure 3b

```{r, echo = FALSE, eval = FALSE}
pdf("../Manuscript/Figures/Figure3_cd_passeriformes_1.pdf", height = 8, width = 8)
par(mfrow = c(2,2))

## Getting the subsets for the colouring
col_subs <- c(split(shapespace$level2, f = shapespace$level1)[-1], "phylogeny" = list(shapespace$level1))

## Set the vector of legend positions
legends_pos <- c("topleft", "topright", "topright", "topright",
                 "topleft", "topright", "topleft", "topright")
legend_counter <- 1

for(i in 1:2) {
    par(mar = c(2,2.5,2,1.5))
    plot.correlations(suborder_phylo_cor[[i]], col.sub = col_subs[[i]], legend.pos = legends_pos[i], ID = i, pt.cex = 0.5, legend.cex = 2/3, legend_counter = legend_counter, contour = NULL, with.quadrant = FALSE)
}


## Fig 3c

# par(mfrow = c(2, 4))
## Getting the subsets for the colouring
col_subs <- c(split(shapespace$level2, f = shapespace$level1)[-1], "phylogeny" = list(shapespace$level1))

## Set the vector of legend positions
legends_pos <- c("bottomright", "topright", "topleft", "topleft",
                 "topleft", "topleft", "topright", "bottomright")
legend_counter <- 1

for(i in 1:2) {
    par(mar = c(2,2.5,2,1.5))
    plot.correlations(suborder_group_cor[[i]], col.sub = col_subs[[i]], legend.pos = legends_pos[i], ID = i, pt.cex = 0.5, legend.cex = 2/3, legend_counter = legend_counter, with.quadrant = TRUE, contour = NULL)
}
dev.off()
```




























































