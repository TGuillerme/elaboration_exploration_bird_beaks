---
title: "Bird beak's elaboration and exploration: data preparation"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

<!-- Compilation time: 30 minutes -->

All the custom code and custom functions called in this document can be downloaded and installed in `R` as the standalone working package `beer` (Beak Elaboration and Exploration in R).
Although `beer` is intentionally designed to be portable and shareable, we advice workers to use it with moderation and tailor it's consumption to their specific research needs.
The following code snippets are used to illustrate the implementation of the functions.
See §§§ for running the actual analyses.

The method described in the next three markdown is essentially a mini chains with pseudo-metropolis coupling markov chain generalised linear mixed model method to determine clades and tips elaboration and exploration (`mcmcpmcmcmcglmmmctee`) but we will refrain using this acronym and method name.


```{r install_beer, eval = FALSE}
## Installing the dispRity branch
devtools::install_github("TGuillerme/dispRity@MCMCglmm")
```

```{r load_beer, eval = TRUE}
## Loading packages
library(dispRity) #v>=1.7
```


# Data preparation

TODO: 

 * [ ] what's the data, where is it from
 * [ ] Procrustes
 * [ ] Building the trait space
   - [ ] form space version?
   - [ ] shape space version?
 * [ ] Clade data and grouping


Trees were manipulated in `R` [@Rcore] using the package `ape` [@ape].

 * The trait space

```{r}
## Reading the different trait spaces
shapespace <- readRDS("../Data/Raw/Beak_data/2020_08_07_MMB_MORPHO_SHAPESPACE_FULL.rds")
shapespace <- shapespace$PCscores
formspace <- readRDS("../Data/Raw/Beak_data/2020_08_07_MMB_MORPHO_FORMSPACE_FULL.rds")
formspace <- formspace$PCscores
```

```{r, echo = FALSE, fig.height = 16, fig.width = 8}
par(mfrow = c(2,1))
plot.dispRity(shapespace, type = "preview", pch = 21, main = "Shape space")
plot.dispRity(formspace, type = "preview", pch = 21, main = "Form space")
```

 * The tree(s)

```{r}
## Reading the consensus tree
consensus_tree <- read.nexus("../Data/Raw/Tree_data/9993taxa_1_tree_Global_MCC_CA.tre")

## Reading the distribution of trees
trees_list <- read.tree("../Data/Raw/Tree_data/AllBirdsHackett1.tre")
```

 * The clade data
We used the different clade levels (the 11 magnificent 7 + the families). For each level/group, we removed any groups with less than 20 species.

```{r}
## Reading the clades list
clades_list <- as.data.frame(read.csv("../Data/Raw/BirdClades.csv", row.names = 1, stringsAsFactors = TRUE))
## Remove the absent species
clades_list <- clades_list[rownames(clades_list) %in% rownames(shapespace), ]
## Sorting the list by rownames from the shapespace
clades_list <- clades_list[match(rownames(shapespace), rownames(clades_list)), -c(6, 7)]
## Renaming the levels
colnames(clades_list) <- c("superorder", "order", "suborder", "superfamily", "family")

## Cleaning the levels (removing any level with less than 15 elements)
update.level <- function(level, min = 15) {
    to_remove <- which(table(level) < min)
    remove_table <- data.frame("clade" = names(to_remove), "species" =  c(table(level)[to_remove]))
    level[which(level %in% c(names(to_remove)))] <-  ""
    return(list(level = as.factor(as.character(level)), removed = remove_table))
}

## Updated list
update_clade_list <- lapply(as.list(clades_list), update.level, min = 15)
clade_list <- data.frame(lapply(update_clade_list, `[[`, 1))
removed_table <- do.call(rbind, lapply(update_clade_list, function(x) {rownames(x$removed) <- NULL; return(x$removed)}))

## Saving the clade list
save(clade_list, file = "../Data/Processed/clade_list.rda")
```

```{r, echo = FALSE}
library(knitr)
kable(removed_table, caption = "List of removed clades by level and number of species in that clade in the dataset.", label = "Table X1")
```


### Selecting the number of axes

How many dimensions do we need to represent at least 95% of the variance in each group

```{r}
## Temporary change the empty levels to noclade
clades <- clades_list[, c(1)]
levels(clades)[1] <- "noclade"

## Make a dispRity object and get axes data
shape_axes <- select.axes(custom.subsets(shapespace, group = clades))
form_axes  <- select.axes(custom.subsets(formspace, group = clades))
```

```{r, echo = FALSE}
kable(summary(shape_axes)[, c(1:((length(shape_axes$dimensions)+1)*2))], caption = "variance per axes for the Shape space", label = "Table X2")
```

```{r, echo = FALSE}
kable(summary(form_axes)[, c(1:((length(form_axes$dimensions)+1)*2))], caption = "variance per axes for the Form space", label = "Table X3")
```

```{r, echo = FALSE, fig.height = 18, fig.width = 18}
plot(shape_axes)
```
Fig X1: variance per axes per superorder and order in the shapespace

```{r, echo = FALSE, fig.height = 18, fig.width = 18}
plot(form_axes)
```
Fig X1: variance per axes per superorder and order in the formspace


By analysing the distribution of the variance within each group, we will need `r length(shape_axes$dimensions)` dimensions for the shape space and `r length(form_axes$dimensions)` for the form space.


### Saving the data

Here we are going to group the spaces, trees and levels for subsequent levels (nested).
There are 5 levels: Super order (1), Order (2), Sub-order (3), Super families (4) and families (5).
The script above creates the model for the two first levels, the subsequent models create the mini-chains for the following overlapping pairs of models (order + sub-order; sub-order + super families; super families + families).

```{r}
source("../Functions/prep.data.R")
## Getting the data ready for all birds
shapespace_allbirds_lvl_superorder_order <- prep.data(
                                          level = 0, lvl.inc = c(1,2),
                                          clades    = clades_list,
                                          space     = shapespace,
                                          dim       = shape_axes$dimensions,
                                          consensus = consensus_tree,
                                          trees     = trees_list,
                                          verbose   = TRUE)
save(shapespace_allbirds_lvl_superorder_order, file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.rda")

## Getting the data ready for each bird super order
shapespace_superorder_lvl_order_suborder <- prep.data(
                                          level = 1, lvl.inc = c(2,3),
                                          clades    = clades_list,
                                          space     = shapespace,
                                          dim       = shape_axes$dimensions,
                                          consensus = consensus_tree,
                                          trees     = trees_list,
                                          verbose   = TRUE)
save(shapespace_superorder_lvl_order_suborder, file = "../Data/Processed/shapespace_superorder_lvl_order_suborder.rda")

## Getting the data ready for each bird order
shapespace_order_lvl_suborder_superfam <- prep.data(
                                          level = 2, lvl.inc = c(3,4),
                                          clades    = clades_list,
                                          space     = shapespace,
                                          dim       = shape_axes$dimensions,
                                          consensus = consensus_tree,
                                          trees     = trees_list,
                                          verbose   = TRUE)
save(shapespace_order_lvl_suborder_superfam, file = "../Data/Processed/shapespace_order_lvl_suborder_superfam.rda")

## Getting the data ready for each bird sub order
shapespace_suborder_lvl_superfam_fam <- prep.data(
                                          level = 3, lvl.inc = c(4,5),
                                          clades    = clades_list,
                                          space     = shapespace,
                                          dim       = shape_axes$dimensions,
                                          consensus = consensus_tree,
                                          trees     = trees_list,
                                          verbose   = TRUE)
save(shapespace_suborder_lvl_superfam_fam, file = "../Data/Processed/shapespace_suborder_lvl_superfam_fam.rda")

## Getting the data ready for each bird super family
shapespace_superfam_lvl_fam <- prep.data(
                                          level = 4, lvl.inc = 5,
                                          clades    = clades_list,
                                          space     = shapespace,
                                          dim       = shape_axes$dimensions,
                                          consensus = consensus_tree,
                                          trees     = trees_list,
                                          verbose   = TRUE)
save(shapespace_superfam_lvl_fam, file = "../Data/Processed/shapespace_superfam_lvl_fam.rda")

## Get a list of all selected levels for the record (and number of elements per levels)
super_orders     <- shapespace_allbirds_lvl_superorder_order[[1]]$levels[[1]]
orders           <- shapespace_allbirds_lvl_superorder_order[[1]]$levels[[2]]
sub_orders       <- lapply(shapespace_order_lvl_suborder_superfam, function(x) x$levels[[1]])
names(sub_orders) <- NULL
sub_orders       <- unlist(sub_orders, recursive = FALSE)
super_families   <- lapply(shapespace_order_lvl_suborder_superfam, function(x) x$levels[[2]])
names(super_families) <- NULL
super_families   <- unlist(super_families, recursive = FALSE)
families         <- lapply(shapespace_superfam_lvl_fam, function(x) x$levels[[1]])
names(families) <- NULL
families         <- unlist(families, recursive = FALSE)

## Get the list of levels
levels_list <- list("super_orders"   = unlist(lapply(super_orders, length)),
                    "orders"         = unlist(lapply(orders, length)),
                    "sub_orders"     = unlist(lapply(sub_orders, length)),
                    "super_families" = unlist(lapply(super_families, length)),
                    "families"       = unlist(lapply(families, length)))
save(levels_list, file = "../Data/Processed/levels_list.rda")
```


## Passeriformes focus

```{r}
## Making a Passeriformes only list
clades_list <- as.data.frame(read.csv("../Data/Raw/BirdClades.csv", row.names = 1, stringsAsFactors = TRUE))
clades_list_passeriformes <- clades_list[which(clades_list$level2_order == "Passeriformes"), c(3, 5)]
clades_list_passeriformes[,1] <- as.factor(as.character(clades_list_passeriformes[,1]))
clades_list_passeriformes[,2] <- as.factor(as.character(clades_list_passeriformes[,2]))


## Shapespace passeriformes
shapespace_passeriformes <- shapespace[rownames(shapespace) %in% rownames(clades_list_passeriformes), ]

## Do the prep data from here (with all the trees! ouch!)
shapsepace_passeriformes_suborder_family <- prep.data(
                                          level = 0, lvl.inc = c(1,2),
                                          clades    = clades_list_passeriformes,
                                          space     = shapespace_passeriformes,
                                          dim       = 1:8,
                                          consensus = consensus_tree,
                                          trees     = trees_list,
                                          verbose   = TRUE)
save(shapsepace_passeriformes_suborder_family, file = "../Data/Processed/shapsepace_passeriformes_suborder_family.rda")
```



## References