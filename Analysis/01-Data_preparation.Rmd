---
title: "Bird beak's elaboration and exploration: data preparation"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

All the custom code and custom functions called in this document can be downloaded and installed in `R` as the standalone working package `beer` (Beak Elaboration and Exploration in R).
Although `beer` is intentionally designed to be portable and shareable, we advice workers to use it with moderation and tailor it's consumption to their specific research needs.
The following code snippets are used to illustrate the implementation of the functions.
See §§§ for running the actual analyses.

The method described in the next three markdown is essentially a mini chains with pseudo-metropolis coupling markov chain generalised linear mixed model method to determine clades and tips elaboration and exploration (`mcmcpmcmcmcglmmmctee`) but we will refrain using this acronym and method name.


```{r install_beer, eval = FALSE}
## Installing beer
devtools::install_github("TGuillerme/elaboration_exploration_bird_beaks/beer")
```

```{r load_beer, eval = TRUE}
## Loading packages
library(dispRity)
library(beer)
library(knitr)
```


# Data preparation

TODO: 

 * [ ] what's the data, where is it from
 * [ ] Procrustes
 * [ ] Building the trait space
   - [ ] form space version?
   - [ ] shape space version?
 * [ ] Clade data and grouping


Trees were manipulated in `R` [@Rcore] using the package `ape` [@ape].

 * The trait space

```{r}
## Reading the different trait spaces
shapespace <- readRDS("../Data/Raw/Beak_data/2020_08_07_MMB_MORPHO_SHAPESPACE_FULL.rds")
shapespace <- shapespace$PCscores
formspace <- readRDS("../Data/Raw/Beak_data/2020_08_07_MMB_MORPHO_FORMSPACE_FULL.rds")
formspace <- formspace$PCscores
```

```{r, echo = FALSE, fig.height = 16, fig.width = 8}
par(mfrow = c(2,1))
plot.dispRity(shapespace, type = "preview", pch = 21, main = "Shape space")
plot.dispRity(formspace, type = "preview", pch = 21, main = "Form space")
```

 * The tree(s)

```{r}
## Reading the consensus tree
consensus_tree <- read.nexus("../Data/Raw/Tree_data/9993taxa_1_tree_Global_MCC_CA.tre")

## Selecting only the tips in the trait space
matching_tips <- consensus_tree$tip.label %in% rownames(shapespace)
consensus_tree <- drop.tip(consensus_tree, tip = consensus_tree$tip.label[!matching_tips])
```

 * The clade data
We used the different clade levels (the 11 magnificent 7 + the families). For each level/group, we removed any groups with less than 20 species.

```{r}
## Reading the clades list
clades_list <- as.data.frame(read.csv("../Data/Raw/BirdClades.csv", row.names = 1, stringsAsFactors = TRUE))
## Remove the absent species
clades_list <- clades_list[rownames(clades_list) %in% rownames(shapespace), ]

#@param table the clade list data frame
#@param level the ID of the column to use as a level
#@param threshold drop levels with less than the threshold
make.level.list <- function(table, level, threshold = 20) {
  ## Select the level
  table_level <- table[, level]
  ## Find the empty level
  empty_level <- which(levels(table_level) == "")
  if(length(empty_level) != 0) {
      ## Remove the empties
      level_list <- as.factor(as.character(table_level[-which(table_level == "")]))
  }
  empty_level <- ""
  ## Select the levels below the threshold
  remove_levels <- which(table(level_list) < threshold)
  ## Remove the levels
  while(length(remove_levels) > 0) {
    level_list <- as.factor(as.character(level_list[-which(level_list == names(remove_levels)[1])]))
    table_level[which(table_level == names(remove_levels)[1])] <- empty_level
    table_level <- as.factor(as.character(table_level))
    remove_levels <- remove_levels[-1]
  }
  ## Convert into a list
  factors <- levels(level_list)
  list_levels <- list()
  while(length(factors) > 0) {
    list_levels[[length(list_levels) + 1]] <- which(level_list == factors[1])
    factors <- factors[-1]
  }
  ## Name the elements correctly
  names(list_levels) <- levels(level_list)

  ## Also returns the new column
  return(list(col = table_level, list = list_levels))
}

## Reading the clades list
groups_level1 <- make.level.list(clades_list, level = 1, threshold = 20)
groups_level2 <- make.level.list(clades_list, level = 2, threshold = 20)
all_groups <- c(groups_level1$list, groups_level2$list)
```


### Selecting the number of axes

How many dimensions do we need to represent at least 95% of the variance in each group

```{r}
## Make a dispRity object
shapespace <- custom.subsets(shapespace, group = all_groups)
formspace  <- custom.subsets(formspace, group = all_groups)
shape_axes <- select.axes(shapespace)
form_axes  <- select.axes(formspace)
```

```{r, echo = FALSE}
kable(summary(shape_axes)[, c(1:((length(shape_axes$dimensions)+1)*2))], caption = "variance per axes for the Shape space", label = "Table X1")
```

```{r, echo = FALSE}
kable(summary(form_axes)[, c(1:((length(form_axes$dimensions)+1)*2))], caption = "variance per axes for the Form space", label = "Table X2")
```

```{r, echo = FALSE, fig.height = 18, fig.width = 18}
plot(shape_axes)
```
Fig X1: variance per axes for the Shape space

```{r, echo = FALSE, fig.height = 18, fig.width = 18}
plot(form_axes)
```
Fig X1: variance per axes for the Form space


By analysing the distribution of the variance within each group, we will need `r length(shape_axes$dimensions)` dimensions for the shape space and `r length(form_axes$dimensions)` for the form space.


### Saving the data

```{r}
## Add the clade columns and the animal column to the spaces
shapespace$level1 <- groups_level1$col
shapespace$level2 <- groups_level2$col
shapespace$animal <- rownames(shapespace)
formspace$level1 <- groups_level1$col
formspace$level2 <- groups_level2$col
formspace$animal <- rownames(formspace)

## Save the data to be analysed in Data/Processed
form_shape_space_1tree_2levels <- list(
    "consensus_tree" = consensus_tree,
    "shape_space"    = shapespace,
    "form_space"     = formspace,
    "groups_list"    = all_groups)

save(form_shape_space_1tree_2levels, file = "../Data/Processed/form_shape_space_1tree_2levels.rda")
```


## References