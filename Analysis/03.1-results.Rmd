---
title: "Bird beak's elaboration and exploration"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

This section contains the code for reproducing the analyses. To get the details, refer to 03-elaboration_exploration_analyses.Rmd.

# Elaboration and exploration analyses

```{r, eval = TRUE, echo = FALSE, print = FALSE}
library(beer)
```

# All birds shapespace analyses

```{r, eval = TRUE, echo = FALSE}
## Load the covar
load(file = "../Data/Processed/allbirds_8748t_8Dshapespace_31levels.rda")
## Load the data
load(file = "../Data/Processed/form_shape_space_1tree_2levels.rda")
shapespace <- form_shape_space_1tree_2levels$shape_space
## Loading the group names
load("../Data/Processed/group_names_level_1_2.rda")

superorder_shapespace <- MCMCglmm.dispRity(
      data          = shapespace,
      posteriors    = allbirds_8748t_8Dshapespace_31levels,
      group         = MCMCglmm.levels(allbirds_8748t_8Dshapespace_31levels)[c(1:8, 32)],
      rename.groups = c(names(group_names_level_1_2), "phylogeny")[c(1:8, 32)])

order_shapespace <- MCMCglmm.dispRity(
      data          = shapespace,
      posteriors    = allbirds_8748t_8Dshapespace_31levels,
      group         = MCMCglmm.levels(allbirds_8748t_8Dshapespace_31levels)[-c(1:8, 33)],
      rename.groups = c(names(group_names_level_1_2), "phylogeny")[-c(1:8,33)])
```


```{r, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 5, echo = FALSE}
## Plotting just the space
sauron.plot(superorder_shapespace,
            main = "Shapespace",
            cex = 0.5,
            legend = FALSE)
```
The global Shape space


```{r, echo = FALSE, fig.height = 18, fig.width = 18, eval = FALSE}
par(mfrow = c(2,2))
## Plotting mean axes
sauron.plot(superorder_shapespace,
            col = c(rainbow(n.subsets(superorder_shapespace)-1), "grey"),
            main = "Average ellipses by super order",
            ellipses = mean,
            legend = FALSE,
            points = FALSE,
            cex = 0.5)
## Plotting mean ellipses
sauron.plot(superorder_shapespace,
            col = c(rainbow(n.subsets(superorder_shapespace)-1), "grey"),
            main = "Average major axes by super order",
            major.axes = mean,
            legend = TRUE,
            points = FALSE,
            cex = 0.5)
## Plotting mean axes
sauron.plot(order_shapespace,
            col = c(rainbow(n.subsets(order_shapespace)-1), "grey"),
            main = "Average ellipses by order",
            ellipses = mean,
            legend = FALSE,
            points = FALSE,
            cex = 0.5)
## Plotting mean ellipses
sauron.plot(order_shapespace,
            col = c(rainbow(n.subsets(order_shapespace)-1), "grey"),
            main = "Average major axes by order",
            major.axes = mean,
            legend = TRUE,
            points = FALSE,
            cex = 0.5)
```
Main axes and ellipses visualisation

## Calculate the elaborations/explorations

```{r, fig.height = 20, fig.width = 10, echo = FALSE, eval = FALSE}
## Run the analyses between groups
super_results_between <- covar.projections.wrapper(superorder_shapespace,
                                             type = "between",
                                             base = "phylogeny",
                                             dispRity.out = TRUE)
## Run the analyses between groups
order_results_between <- covar.projections.wrapper(order_shapespace,
                                             type = "between",
                                             base = "phylogeny",
                                             dispRity.out = TRUE)
## Run the analyses of groups on the phylogeny
super_results_phylo <- covar.projections.wrapper(superorder_shapespace,
                                            type = "within",
                                            base = "phylogeny",
                                            incl.base = TRUE,
                                            dispRity.out = TRUE,
                                            verbose = TRUE)
## Run the analyses of groups on the phylogeny
order_results_phylo <- covar.projections.wrapper(order_shapespace,
                                            type = "within",
                                            base = "phylogeny",
                                            incl.base = TRUE,
                                            dispRity.out = TRUE,
                                            verbose = TRUE)
## Run the analyses groups on themselves
super_results_within <- covar.projections.wrapper(superorder_shapespace,
                                            type = "within",
                                            dispRity.out = TRUE,
                                            verbose = TRUE)
## Run the analyses groups on themselves
order_results_within <- covar.projections.wrapper(order_shapespace,
                                            type = "within",
                                            dispRity.out = TRUE,
                                            verbose = TRUE)
## Save all
allbirds_8748t_8Dshapespace_31levels_results_list <- list(
        "super_results_between" = super_results_between,
        "order_results_between" = order_results_between,
        "super_results_phylo"   = super_results_phylo,
        "order_results_phylo"   = order_results_phylo,
        "super_results_within"  = super_results_within,
        "order_results_within"  = order_results_within)
save(allbirds_8748t_8Dshapespace_31levels_results_list, file = "../Data/Processed/allbirds_8748t_8Dshapespace_31levels_results_list.rda")
```

```{r, echo = FALSE}
## Quick load
load(file = "../Data/Processed/allbirds_8748t_8Dshapespace_31levels_results_list.rda")
results <- allbirds_8748t_8Dshapespace_31levels_results_list
```


```{r, echo = FALSE}
## Plot the results
wrap.plot <- function(results, col, main) {
    ## How many sub plots?
    n <- length(results)
    ## Edit names for cleaning
    # for(i in 1:n) {
    #     names(results[[i]]$disparity) <- gsub(":phylogeny", "", names(results[[i]]$disparity))
    # }

    ## Which will be the centre plot?
    centre <- 1
    ## Plot everything
    op <- par(mfrow = c(n, 1), mar = c(7, 4, 4, 2) + 0.1)
    for(i in 1:n) {
        plot(results[[i]], col = col, main = ifelse(i == centre, main, ""), las = 2, xlab = "")
    }
    par(op)
}
wrap.plot(results$super_results_between,
          col = rainbow(n.subsets(superorder_shapespace)-1),
          main = "Superorders differences")
```
Figure: these results show the projections ("position"), rejection ("distance") and angles ("degree") of the posteriors of each group's major axes onto the corresponding global phylogenetic major axes. For each panel, the highest the score the more the clade is elaborating, exploring, exploring perpendicular to the main axes for the position, distance and degree respectively.


```{r, fig.height = 20, fig.width = 10, echo = FALSE}
wrap.plot(results$order_results_between,
          col = rainbow(n.subsets(order_shapespace)-1),
          main = "Superorders differences")
```

## Elaboration and exploration by species

Similarly to the analyses described above, we ran the analyses for each species.
Here, instead of projecting the major axes of the groups onto the global phylogenetic major axis we projected each species onto the phylogenetic major axis (for each posterior distribution).

```{r, fig.height = 20, fig.width = 10, echo = FALSE, eval = FALSE}
## Plot the results
wrap.plot(results$super_results_phylo,
          col = rainbow(n.subsets(superorder_shapespace)-1),
          main = "Projections per superorder\non the global phylogeny axes")
```
Figure: the projection of each species per group onto the posterior distribution of global major phylogenetic axis.

```{r, fig.height = 20, fig.width = 10, echo = FALSE}

## Plot the results
wrap.plot(results$order_results_phylo,
          col = rainbow(n.subsets(order_shapespace)-1),
          main = "Projections per order\non the global phylogeny axes")
```


Finally, we ran the same analyses but instead of the projection of the species onto the global phylogenetic major axes, we projected them onto their respective group's phylogenetic major axes.




```{r, fig.height = 20, fig.width = 10, echo = FALSE}

## Plot the results
wrap.plot(results$super_results_within,
          col = rainbow(n.subsets(superorder_shapespace)-1),
          main = "Projections per superorder\nonto each superorder")
```
Figure: the projection of each species per group onto the posterior distribution of each clade's major phylogenetic axis (the grey distributions corresponds to the projections of all the species, irregardless of their group, onto the global phylogenetic major axes).


```{r, fig.height = 20, fig.width = 10, echo = FALSE, eval = FALSE}

## Plot the results
wrap.plot(results$order_results_within,
          col = rainbow(n.subsets(order_shapespace)-1),
          main = "Projections per order\nonto each order")
```

## Different scores distributions per species

```{r, eval = TRUE, echo = FALSE, eval = TRUE}
library(hdrcde)

#@param res the results list
#@param type which type (position, distance or angle)
#@param cent.tend which central tendency fun (default is median)
#@param use.hdr whether to use kernel density estimate for the outputs (default is TRUE)
#@param prob which quantiles to use (default is c(50, 95, 99))
#@param exclude.phylo remove the phylogeny subset (default = FALSE)
#@param ... plot options

get.distributions <- function(res, type, cent.tend = median, use.hdr = TRUE, prob = c(50, 95, 99), exclude.phylo = FALSE, ...) {

    ## Remove the phylo one (if needed)
    if(exclude.phylo) {
        select <- names(size.subsets(res[[type]]))
        select <- select[-which(select %in% "phylogeny")]
        res[[type]] <- get.subsets(res[[type]], subsets = select)
    }
    ## Extracting all the results
    disparity <- lapply(res[[type]]$disparity, function(X, type) return(X$elements))

    ## Recentre the results
    if(type == "position") {
        disparity <- lapply(disparity, function(X) return(X-0.5))
    }

    ## Measure the central tendencies
    centrals <- lapply(disparity, function(X, fun) apply(X, 1, fun), fun = cent.tend)
    ## Number of groups
    n_groups <- length(centrals)

    ## Calculate and plot the hdrcde
    op_tmp <- par(mfrow = c(ceiling(sqrt(n_groups)), round(sqrt(n_groups))))
    densities <- list()
    for(i in 1:length(centrals)) {
        if(use.hdr) {
            densities[[i]] <- hdr.den(centrals[[i]], prob = prob, main = names(centrals)[i])#, ...)
        } else {
            hist(centrals[[i]], main = names(centrals)[i], ...)
        }
    }
    par(op_tmp)

    ## Find the extreme species
    get.extremes.hdr <- function(density, central) {
        ## Get the minimums and maximums
        mins <- which(central <= density$hdr[1,1])
        maxs <- which(central >= density$hdr[1, ncol(density$hdr)])
        ## Get their values
        return(c(central[names(mins)], central[names(maxs)]))
    }
    CI.converter <- function(CI) {
        sort(c(50-CI/2, 50+CI/2)/100)
    }
    get.extremes.quantile <- function(central, prob) {
        ## Get the quantiles
        quants <- quantile(central, probs = CI.converter(max(prob)))
        ## Get the minimums and maximums
        mins <- which(central <= quants[1])
        maxs <- which(central >= quants[2])
        ## Get their values
        return(c(central[names(mins)], central[names(maxs)]))
    } 

    if(use.hdr) {
        output <- mapply(get.extremes.hdr, densities, centrals, SIMPLIFY = FALSE)
        names(output) <- names(centrals)
    } else {
        output <- lapply(centrals, get.extremes.quantile, prob = prob)
    }

    ## Return the as a table
    for(i in 1:length(output)) {
        if(length(output[[i]]) == 0) {
            output[[i]] <- data.frame("level" = names(output)[i], "species" = NA, "score" = NA)
        } else {
            output[[i]] <- data.frame("level" = rep(names(output)[i], length(output[[i]])),
                                      "species" = names(output[[i]]),
                                      "score"   = unname(output[[i]]))
        }
    }

    return(output)
}
combine.results <- function(res1, res2) {
    ## Combine the results
    res_out <- rbind(res1[,1:2], res2[, 1:2])
    res_out$elaboration <- c(res1[, 3], rep(NA, nrow(res2)))
    res_out$exploration <- c(rep(NA, nrow(res1)), res2[, 3])
    ## Find any species in commons
    commons <- intersect(res1$species, res2$species)
    if(length(commons) > 0 && is.na(commons)) {
        if(is.na(res1$species)) {
            if(is.na(res2$species)) {
                ## Both are NA (keep just the first one)
                res_out <- res_out[-1, , drop = FALSE]
            } else {
                ## Remove res1
                res_out <- res_out[-1, , drop = FALSE]
            }
        } else {
            ## Remove res2
            res_out <- res_out[1:length(res1$species), , drop = FALSE]
        }
    } else {
        ## Recursively remove the ones in common
        while(length(commons) > 0) {
            duplicates <- which(res_out$species == commons[1])
            res_out[duplicates[1], 4] <- res_out[duplicates[2], 4]
            res_out <- res_out[-duplicates[2], ]
            commons <- commons[-1]
        }
    }
    return(res_out)
}
```


### Extreme species per super order (based on phylogeny)


```{r, eval = TRUE, echo = FALSE, fig.height = 12, fig.width = 12, eval = TRUE}
super_positions_phylo <- get.distributions(results$super_results_phylo, type = "position")
```
Figure: elaborations distributions per super orders

```{r, eval = TRUE, echo = FALSE, fig.height = 12, fig.width = 12, eval = TRUE}
super_distances_phylo <- get.distributions(results$super_results_phylo, type = "distance")
```
Figure: explorations distributions per super orders

```{r, echo = FALSE}
library(knitr)
## Combining the results
super_phylo_table <- do.call(rbind, mapply(combine.results, super_positions_phylo, super_distances_phylo, SIMPLIFY = FALSE))
rownames(super_phylo_table) <- NULL
kable(super_phylo_table, digits = 3)
```


### Extreme species per order (based on phylogeny)

```{r, eval = TRUE, echo = FALSE, fig.height = 24, fig.width = 24, eval = TRUE}
order_positions_phylo <- get.distributions(results$order_results_phylo, type = "position", exclude.phylo = TRUE)
```
Figure: elaborations distributions per order

```{r, eval = TRUE, echo = FALSE, fig.height = 24, fig.width = 24, eval = TRUE}
order_distances_phylo <- get.distributions(results$order_results_phylo, type = "distance", exclude.phylo = TRUE)
```
Figure: explorations distributions per order

```{r, echo = FALSE}
## Combining the results
order_phylo_table <- do.call(rbind, mapply(combine.results, order_positions_phylo, order_distances_phylo, SIMPLIFY = FALSE))
rownames(order_phylo_table) <- NULL
kable(order_phylo_table, digits = 3)
```




### Extreme species per super order (within)


```{r, eval = TRUE, echo = FALSE, fig.height = 12, fig.width = 12, eval = TRUE}
super_positions_within <- get.distributions(results$super_results_within, type = "position", exclude.phylo = TRUE)
```
Figure: elaborations distributions within super orders

```{r, eval = TRUE, echo = FALSE, fig.height = 12, fig.width = 12, eval = TRUE}
super_distances_within <- get.distributions(results$super_results_within, type = "distance", exclude.phylo = TRUE)
```
Figure: explorations distributions within super orders

```{r, echo = FALSE}
## Combining the results
super_phylo_table_within <- do.call(rbind, mapply(combine.results, super_positions_within, super_distances_within, SIMPLIFY = FALSE))
rownames(super_phylo_table_within) <- NULL
kable(super_phylo_table_within, digits = 3)
```




### Extreme species per order (within)


```{r, eval = TRUE, echo = FALSE, fig.height = 12, fig.width = 12, eval = TRUE}
order_positions_within <- get.distributions(results$order_results_within, type = "position", exclude.phylo = TRUE)
```
Figure: elaborations distributions within orders

```{r, eval = TRUE, echo = FALSE, fig.height = 12, fig.width = 12, eval = TRUE}
order_distances_within <- get.distributions(results$order_results_within, type = "distance", exclude.phylo = TRUE)
```
Figure: explorations distributions within orders

```{r, echo = FALSE}
## Combining the results
order_phylo_table_within <- do.call(rbind, mapply(combine.results, order_positions_within, order_distances_within, SIMPLIFY = FALSE))
rownames(order_phylo_table_within) <- NULL
kable(order_phylo_table_within, digits = 3)
```