---
title: "Bird beak's elaboration and innovation"
author: "Gavin Thomas & Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---


## Calculate the lambdas for the whole tree and nested clades

```{r, echo = FALSE}
## Loading the clade info
load("../Data/Processed/group_species_names.rda")

## Loading the plotting data
load("../Data/Processed/ploting_data.rda")

## Function for measuring Pagel's lambda from a sub-tree
#' @param species a vector of species names to extract from tree
#' @param variable the variable (a named vector with the correct species names)
#' @param tree the full tree
#' @param method the method to be passed to motmot::transformPhylo.ML (default is "lambda")
#' @param ... any other arguments to be passed to motmot::transformPhylo.ML
get.p.lambda <- function(species, variable, tree, method = "lambda", ...) {
    ## Selected species
    to_keep <- tree$tip.label %in% species

    ## Trim the tree
    sub_tree <- drop.tip(tree, tip = tree$tip.label[!to_keep])
    
    ## Trim the variable
    sub_var <- variable[species]

    ## Measure lambda
    return(motmot::transformPhylo.ML(phy = sub_tree, y = matrix(sub_var, ncol = 1, dimnames = list(names(sub_var))), model = method, ...))
}


## Get the lambdas for all levels for the elaborations
overall_lambda_elaboration <- get.p.lambda(species = ploting_data$consensus_tree$tip.label, variable = ploting_data$median_elaborations, tree = ploting_data$consensus_tree, modelCIs = FALSE)
all_lambdas_elaboration <- lapply(group_species_names, lapply, function(x, tree, variable, ...) {cat(".") ; get.p.lambda(names(x), variable, tree, ...)},
                                  tree = ploting_data$consensus_tree,
                                  variable = ploting_data$median_elaborations,
                                  modelCIs = FALSE)
overall_lambda_innovation <- get.p.lambda(species = ploting_data$consensus_tree$tip.label, variable = ploting_data$median_innovations, tree = ploting_data$consensus_tree, modelCIs = FALSE)
all_lambdas_innovation <- lapply(group_species_names, lapply, function(x, tree, variable, ...) {cat(".") ; get.p.lambda(names(x), variable, tree, ...)},
                                  tree = ploting_data$consensus_tree,
                                  variable = ploting_data$median_innovations,
                                  modelCIs = FALSE)
## Make into a table
lambda_elaboration <- list(overall_lambda_elaboration$Lambda, lapply(all_lambdas_elaboration, lapply, function(X) return(X$Lambda)))
lambda_innovation <- list(overall_lambda_innovation$Lambda, lapply(all_lambdas_innovation, lapply, function(X) return(X$Lambda)))
lambda_table <- cbind(unlist(lambda_elaboration), unlist(lambda_innovation))
lambda_table <- data.frame(rbind(c("class", "aves"), do.call(rbind, strsplit(rownames(lambda_table), split = "\\."))), lambda_table)
colnames(lambda_table) <- c("level", "name", "elaboration", "innovation")
rownames(lambda_table) <- lambda_table$name
```

```{r}
rownames(lambda_table) <- NULL
## Save the lambda table:
knitr::kable(lambda_table)
```
