---
title: "Bird beak's elaboration and exploration"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

Benchmarking `MCMCglmm` running times

```{r, load pkg and data}
library(beer)
library(MCMCglmm)
data(chara_data)
data(chara_tree)
```

Measure:
 * `size` the object size
 * `d_size` the object size difference compared to the first test
 * `r_size` the object size increase rate (estimated as `d_size/iteration_differences`)
 * `time` the elapsed time
 * `d_time` the elapsed time difference compared to the first test
 * `r_time` the elapsed time increase rate (estimated as `d_time/iteration_differences`)

Variables:
 * number of dimensions
 * thinning rate
 * saving parameters from `MCMCglmm`

Saving parameters:
 * `pr = TRUE/FALSE`: save the posteriors of the random effects (FALSE?)
 * `pl = TRUE/FALSE`: save the posteriors of the latent variable (TRUE?)
 * `DIC = TRUE/FALSE`: deviance and deviance information criterion are calculated
 * `saveX = TRUE/FALSE`: save fixed effect design matrix
 * `saveZ = TRUE/FALSE`: save random effect design matrix
 * `saveXL = TRUE/FALSE`: save structural parameter design matrix

Protocol:
 1. Run one chain with the set number of parameters for 10 iterations (thinning = 1)
 2. Run it again for 20 iterations (thinning = 1)
 3. Run it again for 30 iterations (thinning = 1)
 4. Run it again for 40 iterations (thinning = 1)
 5. Run it again for 50 iterations (thinning = 1)



```{r, run param chains}
## Set up the parametrising chains models
param_10g_2d <- make.mini.chains(data         = chara_data,
                                   dimensions   = c(1:2),
                                   tree         = chara_tree,
                                   trait.family = "gaussian",
                                   randoms      = c("global", "clade"),
                                   residuals    = "global",
                                   priors       = 0.02,
                                   verbose      = TRUE,
                                   parameters   = list(
                                       nitt   = 10,
                                       thin   = 1,
                                       burnin = 0))
## Set up the parametrising chains models
param_20g_2d <- make.mini.chains(data         = chara_data,
                                   dimensions   = c(1:2),
                                   tree         = chara_tree,
                                   trait.family = "gaussian",
                                   randoms      = c("global", "clade"),
                                   residuals    = "global",
                                   priors       = 0.02,
                                   verbose      = TRUE,
                                   parameters   = list(
                                       nitt   = 20,
                                       thin   = 1,
                                       burnin = 0))
## Set up the parametrising chains models
param_30g_2d <- make.mini.chains(data         = chara_data,
                                   dimensions   = c(1:2),
                                   tree         = chara_tree,
                                   trait.family = "gaussian",
                                   randoms      = c("global", "clade"),
                                   residuals    = "global",
                                   priors       = 0.02,
                                   verbose      = TRUE,
                                   parameters   = list(
                                       nitt   = 30,
                                       thin   = 1,
                                       burnin = 0))
## Set up the parametrising chains models
param_40g_2d <- make.mini.chains(data         = chara_data,
                                   dimensions   = c(1:2),
                                   tree         = chara_tree,
                                   trait.family = "gaussian",
                                   randoms      = c("global", "clade"),
                                   residuals    = "global",
                                   priors       = 0.02,
                                   verbose      = TRUE,
                                   parameters   = list(
                                       nitt   = 40,
                                       thin   = 1,
                                       burnin = 0))
## Set up the parametrising chains models
param_50g_2d <- make.mini.chains(data         = chara_data,
                                   dimensions   = c(1:2),
                                   tree         = chara_tree,
                                   trait.family = "gaussian",
                                   randoms      = c("global", "clade"),
                                   residuals    = "global",
                                   priors       = 0.02,
                                   verbose      = TRUE,
                                   parameters   = list(
                                       nitt   = 50,
                                       thin   = 1,
                                       burnin = 0))
param_list <- list(param_10g_2d,
                   param_20g_2d,
                   param_30g_2d,
                   param_40g_2d,
                   param_50g_2d)
```



```{r }
## Recording the results
system(paste("echo \"thin, iterations, dimensions, time, d_time, r_time, size, d_size, r_size\" > recording.csv"))

## First iteration
timer_base <- system.time(param_chains <- run.mini.chains(param_list[[1]], replicates = 1))["elapsed"]
chain_size_base <- object.size(param_chains)

## Saving the results
parameters <- paste(1, 10, 2, sep = ", ")
data <- paste(timer_base, 0, timer_base/10, chain_size_base, 0, chain_size_base/10, sep = ", ")
system(paste("echo \"", paste(parameters, data, sep = ", "), "\" >> recording.csv"))

## Other iterations
## Difference in iterations
d_itt <- 10
timer <- system.time(param_chains <- run.mini.chains(param_list[[2]], replicates = 1))["elapsed"]
chain_size <- object.size(param_chains)
parameters <- paste(1, 10 + d_itt, 2, sep = ", ")
data <- paste(timer, timer-timer_base, (timer-timer_base)/d_itt, chain_size, chain_size-chain_size_base, (chain_size-chain_size_base)/d_itt, sep = ", ")
system(paste("echo \"", paste(parameters, data, sep = ", "), "\" >> recording.csv"))


```