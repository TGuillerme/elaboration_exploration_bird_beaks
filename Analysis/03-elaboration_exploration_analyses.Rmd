---
title: "Bird beak's elaboration and exploration"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---


All the custom code and custom functions called in this document can be downloaded and installed in `R` as the standalone working package `beer` (Beak Elaboration and Exploration in R).
Although `beer` is intentionally designed to be portable and shareable, we advice workers to use it with moderation and tailor it's consumption to their specific research needs.
Some analyses in `beer` do take some time to run so we advice to not drive or operate heavy machinery while using it.
Don't use it while driving.
The following code snippets are used to illustrate the implementation of the functions.
See <!-- §§§run_replicates_script --> for running the actual analyses.

# Elaboration and exploration analyses

```{r, eval = TRUE, echo = FALSE}
library(beer)
## Loading the MCMCglmm
load("../Data/processed/combined_results.rda")
## Loading the tree and data
data(demo_data)
data(demo_tree)
## Setting the colour vector
colour_vector <- c("orange", "blue", "darkgreen")
```

## Extracting the variance covariance matrices from the MCMCglmm mini-chains

To analyse the exploration and elaboration aspects of both clades and tips, we first selected a random 1000 covariance matrices from the combined MCMCglmm posterior variance-covariance matrices.

```{r, eval = TRUE}
set.seed(42)
## Selecting 1000 random covariance matrices from the MCMCglmm
covar_matrices <- get.covar(combined_results, n = 100)
```

We will use these covariance matrices as the basis of the phylogenetic main axes of variation.
These axes correspond to the main axes of variation in the $N_DIMENSIONS$ trait space at different levels: 

 * The whole bird phylogeny level ("phylogeny level");
 * And the named node levels ("clade levels").

These major axes where calculated as the longest distance within the 95% confidence interval hyper-ellipse from the variance-covariance matrix (i.e. the major axes of the 95% CI ellipse of matrix).
In practice, the coordinates of these axes end points were calculated directly from the cross product between the 95% unit hypersphere scaled by the variance-covariance matrix's squared eigen values and the variance-covariance matrix's eigen vectors.

## Major axes calculation

For $O_{n}$, the unit hypersphere matrix of _n_ dimensions and of radius being composed of the two identity matrices $I_{n}$ and $-I_{n}$ so that: 

\begin{equation}
O_{n} = 
    \begin{pmatrix}
        1 & 0 & \cdots & 0 \\
        0 & 1 & \cdots & 0 \\
        \vdots  & \vdots  & \ddots & \vdots  \\
        0 & 0 & \cdots & 1 \\
        -1 & 0 & \cdots & 0 \\
        0 & -1 & \cdots & 0 \\
        \vdots  & \vdots  & \ddots & \vdots  \\
        0 & 0 & \cdots & -1 \\
    \end{pmatrix}
\end{equation}

(in other words $O_{n}$ is the matrix representing each edge point of the unit hyper sphere of $n$ dimensions and of radius $1$);

And $O'_{n}$ the scaled matrix hyper sphere to the right confidence interval size using the $\chi^2$ distribution:

\begin{equation}
    O'_{n} = O_{n} \sqrt{\chi^2(0.95)}
\end{equation}

For the variance-covariance matrix $VCV_{n}$ of $n$ dimensions

\begin{equation}
VCV_{n} = 
    \begin{pmatrix}
        \sigma(a) & \sigma(a,b) & \cdots & \sigma(a,n) \\
        \sigma(a,b) & \sigma(b) & \cdots & \sigma(b,n) \\
        \vdots  & \vdots  & \ddots & \vdots  \\
        \sigma(n,a) & \sigma(n,b) & \cdots & \sigma(n) \\
    \end{pmatrix}
\end{equation}


and the eigenvectors **v** and the eigenvalues $\lambda$ satisfying the following eigen decomposition:

\begin{equation}
    VCV_{n} \bold{v} = \lambda \bold{v}
\end{equation}

We can get $M_{n}$ matrix containing all the edges' coordinates of the 0.95 CI hypersphere from $VCV_{n}$ using the transposition of the cross product between the eigenvectors **v** and the product of the scale 0.95 CI unit sphere $O'_{n}$ and the eigenvalues $\lambda$:

\begin{equation}
    M_{n} = [(O'_{n}\sqrt{\lambda}) \times \bold{v}]^{\text{T}}
\end{equation}

Where $M_{1,n}$ is the major axes of the 0.95 CI hyper ellipse fitting the variance-covariance matrix, $M_{2,n}$ the second second axes (minor axes in 2D), etc...

> The detailed procedure was adapted from [李哲源's post on Stack Overflow](https://stackoverflow.com/questions/40300217/obtain-vertices-of-the-ellipse-on-an-ellipse-covariance-plot-created-by-care/40316331#40316331) and implemented in `beer::get.axis` ([specific procedure on lines 40-73](https://github.com/TGuillerme/elaboration_exploration_bird_beaks/blob/master/beer/R/get.axes.R)).

```{r}
## Calculating the major axes
major_axes <- get.axes(covar_matrices, centre = "intercept")
```

One can visualise these ellipses and major axes in 2D using the `beer::plot.axes` and `beer::plot.ellipses` functions (based on @ellipse):

```{r}
## Plotting the ellipses
plot.ellipses(covar_matrices, col = c("grey",colour_vector),
              add = FALSE)
plot.axes(major_axes, col = c("grey",colour_vector),
              add = TRUE)
legend("topleft", legend = c("all_clades", levels(demo_data$clade)), col = c("grey", colour_vector), pch = 19)
```

We can then compare these axes either between each other or relative to the tips positions in the trait space using elaboration and exploration scores:

## Elaboration and exploration scores calculations

From these major axes, we can use linear algebra in $n$ dimensions to estimate clades or tips' exploration and elaboration scores.
These scores are a direct interpretation of @endler2005's elaboration and innovation (here exploration) patterns (Fig 1. in @endler2005):
Given a major axis of evolutionary "trajectory" (in the sense of evolutionary trend, not an evolutionary direction), on can calculate the elaboration score as the projection value of any vector defined by a clade or a tip on the major axis and the exploration (or "innovation" in @endler2005) as that vector's rejection.

```{r, echo = FALSE, eval = TRUE}
source("../Functions/test.rotation.R")
```
Figure: in a space with 5 elements: A, B, C, D, E (in grey); where D and E represent the major axes (e.g. the major phylogenetic effect axes from the MCMCglmm), we can rotate and rescale each element so that D and E become the unit vector of length 1 (the black letters D and E) and get the exploration elaboration scores for either the elements (e.g. element A's projection in blue and its rejection in orange) or from any other axes (e.g. the major phylogenetic effect axes from the MCMCglmm from a specific clade).

#### Measuring projection and rejection

For any vectors $\vec{a}$ and $\vec{b}$, defined either as one set or a pair of sets of coordinates in $n$ dimensions:

\begin{equation}
    \vec{a} = 
    \begin{bmatrix}
    x \\
    y \\
    \cdots \\
    n \\
    \end{bmatrix}
\end{equation}

\begin{equation}
    \vec{a} = 
    \begin{bmatrix}
    x_{1} & x_{2} \\
    y_{1} & y_{2} \\
    \cdots & \cdots \\
    n_{1} & n_{2} \\
    \end{bmatrix}
\end{equation}

We can calculate $\vec{a_{1}}$, the orthogonal projection of $\vec{a}$ onto $\vec{b}$ using:

\begin{equation}
    \vec{a_{1}} = \frac{\vec{a} \cdot \vec{b}}{\|\vec{b}\|}
\end{equation}

With $\|\vec{b}\| = \sqrt{\vec{b} \cdot \vec{b}}$ being the norm of $\vec{b}$.
And $\vec{a_{2}}$, the rejection of $\vec{a}$ onto $\vec{b}$:

\begin{equation}
    \vec{a_{2}} = \vec{a} - \vec{a_{1}}
\end{equation}


#### Generalisation of projection onto any vector in a set space

Using this, we can calculate the projection and rejection for any element within a trait space $TS_{m,n}$:

\begin{equation}
    TS_{m,n} = 
    \begin{bmatrix}
    x_{1} & x_{2} & \cdots & x_{m} \\
    y_{1} & y_{2} & \cdots & y_{m} \\
    \vdots  & \vdots  & \ddots & \vdots \\
    n_{1} & n_{2} & \cdots & n_{m} \\
    \end{bmatrix}
\end{equation}

And any base vector $\vec{B}$ defined as:

\begin{equation}
    B = 
    \begin{bmatrix}
    x_{1} & x_{2}\\
    y_{1} & y_{2}\\
    \vdots  & \vdots  \\
    n_{1} & n_{2} \\
    \end{bmatrix}
\end{equation}

By using the linear transformation $f_{\vec{B}}$ of the trait space $TS$ moving $\vec{B}$ onto $TS$'s first axes unit vector $\vec{\hat{\imath}}$:

\begin{equation}
    f_{\vec{B}}(TS) = \left( \frac{TS - [Bx_{1}, By_{1}, \cdots, Bn_{1}]^{\text{T}}}{\|\vec{B}\|} \right) \cdot R_{\vec{B}}
\end{equation}

With R_{\vec{B}} being the rotation matrix of the vector $\vec{B}$ onto $\vec{\hat{\imath}}$:

\begin{equation}
R_{\vec{B}} = I_{\vec{B}} - \vec{B}\vec{B}^\text{T} - \vec{\hat{\imath}}\vec{\hat{\imath}}^\text{T} + [\vec{B} \vec{\hat{\imath}}]     \begin{bmatrix}
        cos(\theta) & -sin(\theta)\\
        sin(\theta) & cos(\theta)\\
    \end{bmatrix} [\vec{B} \vec{\hat{\imath}}]^\text{T}
\end{equation}

Where $\theta$ is:

\begin{equation}
    \theta = acos \left(\frac{\vec{B} \cdot \vec{\hat{\imath}}}{\|\vec{B}\| \cdot \|\vec{\hat{\imath}}\|} \right)
\end{equation}

Or $\theta = acos (B_x)$ since both $\|\vec{B}\|$ and $\|\vec{\hat{\imath}}\|$ are equal to 1 and $\|\vec{\hat{\imath}}\|$ is the unit vector on the first axis.

#### Algorithm for calculating the projection/rejection of any element in a defined space

In practice we followed [this procedure](https://math.stackexchange.com/questions/598750/finding-the-rotation-matrix-in-n-dimensions) and applied a modification of [this implementation](https://stackoverflow.com/questions/42520301/find-rotation-matrix-of-one-vector-to-another-using-r/42542385#42542385) (see @aguilera2004 for the formal generalisation of this algorithm) using the following algorithm:

 1. In the trait space, define $\vec{B}$ as the base vector (typically $\vec{B}$ is defined as the pair of coordinates set from the major axis described above).
 2. Centre the trait space on the origin of $\vec{B}$ so that the first set of coordinates of $\vec{B}$ are 0.
 3. Scale the trait space to the norm of $\vec{B}$ so that the norm of $\vec{B}$ is now 1.
 4. Rotate the trait space using the rotation matrix $R_{\vec{B}}$ to satisfy the linear transformation $\vec{B} \arrow \vec{\hat{\imath}}$ (with $\vec{\hat{\imath}}$ being the first unit vector of the trait space - typically the x axes unit vector). 
 5. Project/reject every element in the trait on $\vec{B}$ (that is now $\vec{\hat{\imath}}$). In practice, the first coordinate (x) of each element is now it's projection onto $\vec{B}$.


## References