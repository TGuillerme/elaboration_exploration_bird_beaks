---
title: "Bird beak's elaboration and innovation"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
bibliography: references.bib
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

This section contains the code for reproducing the analyses. To get the details, refer to 03-elaboration_innovation_analyses.Rmd.

```{r, eval = TRUE, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE, print = FALSE}
library(dispRity)
```

# All birds shapespace analyses

```{r, eval = TRUE, echo = FALSE}
## Load the data
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.rda")
## Select the data
shapespace <- shapespace_allbirds_lvl_superorder_order[[1]]$space
tree <- shapespace_allbirds_lvl_superorder_order[[1]]$consensus_tree
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)

## Load the covar
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order.MCMCglmm")
shapespace_allbirds_lvl_superorder_order <- shapespace_allbirds_lvl_superorder_order[[1]]

## Get the levels
phylo_lvl <- which(MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order) == "animal")
super_lvl <- grep("level1_", MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order))
order_lvl <- grep("level2_", MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order))

## Creating the subsets
superorder_shapespace <- MCMCglmm.subsets(n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_allbirds_lvl_superorder_order,
      group         = MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order)[c(super_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level1)[-1], "phylogeny")) #[-1] is because the first level is ""

order_shapespace <- MCMCglmm.subsets(n = 1000, # Just run it on 1k matrices for now
      data          = shapespace,
      posteriors    = shapespace_allbirds_lvl_superorder_order,
      group         = MCMCglmm.levels(shapespace_allbirds_lvl_superorder_order)[c(order_lvl, phylo_lvl)],
      rename.groups = c(levels(shapespace$level2)[-1], "phylogeny")) #[-1] is because the first level is ""
## Clean garbage
rm(shapespace_allbirds_lvl_superorder_order)
```

First we can visualise the global bird shape space (or at least the 2 first of the 8 dimensions):

```{r, message = FALSE, warning = FALSE, fig.height = 8, fig.width = 8, echo = FALSE}
## The ggplot color panel
gg.color.hue <- function(n) {
    grDevices::hcl(h = seq(15, 375, length = n + 1), l = 65, c = 100)[1:n]
}

# colour.palette <- rainbow
colour.palette <- gg.color.hue
```

```{r, echo = FALSE}
## Quick load
load(file = "../Data/Processed/shapespace_allbirds_lvl_superorder_order_results_list.rda")
results <- shapespace_allbirds_lvl_superorder_order_results_list
rm(shapespace_allbirds_lvl_superorder_order_results_list)
```

## Phylogeny window (detailed)

```{r}
## Plotting the ellipses
plot.one.ellipse <- function(data, ID, colours, x = TRUE, y = TRUE, main = "", legend = FALSE) {

    ## Get the PC %ages
    if(x || y) {
        vars <- dispRity::variances(data$matrix[[1]])
        pc_var <- round((vars/sum(vars)*100), 2)
    }

    ## Do the empty plot
    plot(NULL, xlim = c(-1.1, 1.1), ylim = c(-1.1, 1.1), xaxt = "n", yaxt = "n", xlab = ifelse(x, paste0("PC1 (", pc_var[1], "%)"), ""), ylab = ifelse(y, paste0("PC2 (", pc_var[2], "%)"), ""), main = main)
    if(x) axis(1)
    if(y) axis(2)
    abline(v = 0, col = "grey", lwd = 0.5)
    abline(h = 0, col = "grey", lwd = 0.5)

    covar.plot(get.subsets(data, subsets = names(data$subsets)[ID]),
           col = colours[ID],
           ellipses = mean,
           legend = FALSE,
           points = FALSE,
           cex = 0.5, apply.to.VCV = TRUE,
           lwd = 4,
           add = TRUE,
           legend = legend)
}
## Plot the projection/rejection
plot.one.proj.rej <- function(data, ID, colours, x = TRUE, y = TRUE, main = "") {

    ## Get the proj/rej
    if(ID == 1) {select <- 2} else {select <- ID-1}
    elaboration <- c(get.disparity(data$position, concatenate = FALSE)[[select]])
    exploration <- c(get.disparity(data$distance, concatenate = FALSE)[[select]])

    ## Change the colours
    col <- c(colours[[ID]], adjustcolor(colours[[ID]], alpha.f = 0.5))
    ## Plot the results
    par(mar = c(2, 6, 2, 2)+0.1, bty = "n")
    boxplot(cbind(elaboration, exploration), horizontal = TRUE, ylim = c(0,15), col = col, las = 1, xaxt = ifelse(x, "l", "n"), yaxt = ifelse(y, "l", "n"))
}

pdf(file = "Figure_1a.pdf", height = 11, width = 5.5)
## Plot the phylo ellipse
grey_palette <- c(colour.palette(8), "grey")
par(mfrow = c(2,1), bty = "n")
plot.one.ellipse(superorder_shapespace, ID = c(1,9), colours = grey_palette, x = TRUE, y = TRUE, main = "A")
legend("topright", lwd = 5, col = grey_palette[c(1,9)], lty = 1, legend = c("Aequornithes' median variance-covariance", "Overall phylogenetic's median variance-covariance"), bg = "white")
plot.one.proj.rej(results$super_results_between, ID = 1, colours = grey_palette)
```



```{r}
# pdf(file = "Figure_1b.pdf", height = 16, width = 14)
## Global window
layout_matrix <- layout(cbind(matrix(1, ncol = 3, nrow = 8),
                              matrix(2:((8*2)+1), ncol = 2, nrow = 8, byrow = TRUE)))
# layout.show(layout_matrix)


## Plotting the tree

tree <- ladderize(tree)
## Get the tip_values
orders_lvl <- shapespace$level2
superorders_lvl <- shapespace$level1

## Replace the order levels as colours
coloured_levels <- superorders_lvl
colour_palette <- c("grey", colour.palette(length(levels(coloured_levels)[-1])))
levels(coloured_levels) <- c("grey", colour.palette(length(levels(coloured_levels)[-1])))
par(mar = c(1, 1, 1, 1)+0.1)
plot(tree, show.tip.label = FALSE, edge.color =  match.tip.edge(as.character(coloured_levels), tree, replace.na = "grey"))


colour_palette <- levels(coloured_levels)


## Plotting the clade names
## Finding the ladderized clade names
# dev.new()
# plot(x = rep(1, 9), y = c(1:9), pch = 19, col = colour_palette)
# text(x = rep(1, 9), y = c(1:9), label = paste(1:9, levels_ID), col = colour_palette)

levels_ID <- levels(superorders_lvl)
ladder_order <- c("Paleognathae" = 7, "Galloanserae" = 4, "Mirandornithes" = 5, "Columbiomorphae" = 3, "Otidimorphae" = 6, "Aequornithes" = 2, "Strisores" = 8, "Telluraves" = 9)


# par(mfrow = c(length(levels(orders_lvl))), 1)
# par(mfrow = c(length(levels(coloured_levels)), 1), mar = c(2,2,2,0), bty = "n")

#TODO: order the levels to fit the ladderised tree

for(i in 1:8) {

    ## Plot the clade name
    # par(bty = "n", mar = c(1, 1, 1, 1)+0.1)
    # plot(NULL, xaxt = "n", yaxt = "n", xlim = c(-1, 1), ylim = c(-1, 1), xlab = "", ylab = "")

    ## Plot the ellipse
    par(bty = "n", mar = c(1, 1, 1, 1)+0.1)
    plot.one.ellipse(superorder_shapespace, ID = ladder_order[i], colours = colour_palette, x = FALSE, y = FALSE)
    text(0,1, names(ladder_order)[i], cex = 2, col = colour_palette[][ladder_order[i]])

    ## Plot the elaboration/exploration
    par(bty = "n", mar = c(3, 1, 1, 1)+0.1)
    plot.one.proj.rej(results$super_results_between, ID = ladder_order[i], colours = colour_palette, x = TRUE, y = FALSE)

}


```