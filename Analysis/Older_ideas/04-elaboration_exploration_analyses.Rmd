---
title: "04-elaboration exploration analyses"
author: "Thomas Guillerme"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

# Elaboration/exploration analyses

```{r}
## Loading the packages and data
library(dispRity)
load(file = "../Data/Processed/disparity_matrices.rda")
load(file = "../Data/Processed/trees_list.rda")
load(file = "../Data/Processed/spaces_list.rda")
load(file = "../Data/Processed/tmp_simple_matrices.rda")
```

We can add some evo perspective to the basic Endler's elaboration/exploration idea by making the base vector "evolutionary" and by looking at elaboration/exploration through time!

> TODO: I haven't done implementing all the fuzzy space thingies in `dispRity` so for now it's just going to be a naive 1 tree 1 ace 1 answer version of it

## Elaboration/exploration evolutionary metrics

Measure the different elaboration vs exploration metrics with different vectors:
 
 - [ ] MRCA trajectory: the vector between the root of the tree and the OTU's descendant (`"root-anc"`)
 - [ ] MRCA average trajectory: the vector between the centroid of the group's nodes and the root of the tree (`"cent-anc"`)
 - [ ] Evolutionary living average trajectory: the vector between the root of the tree and the centroid of the living taxa (`"root-tip"`)
 - [ ] Evolutionary overall average trajectory: the vector between the root of the tree and the centroid of the tips and nodes (`"root-cent"`)
 - [ ] Maximum living trajectory: the vector between the two most distant OTUs (`"tip-span"`)
 - [ ] Maximum evolutionary trajectory: the vector between the root and the OTU most nodes away from the root (`"root-nested"`)

```{r}
## Utility functions
project.reject <- function(data, vector, absolute = TRUE) {

    ## Get the projection
    projection <- projections.tree(
          matrix = data$matrix[[1]], 
          tree = data$tree[[1]],
          measure = "position", type = vector)

    ## Get the rejection
    rejection <- projections.tree(
          matrix = data$matrix[[1]], 
          tree = data$tree[[1]],
          measure = "distance", type = vector)

    ## Combine and out
    if(absolute) {
      return(cbind(abs(projection), rejection))
    } else {
      return(cbind(projection, rejection))
    }
}
plot.project.reject <- function(results, data, xlab = "Elaboration", ylab = "Exploration", col = "black", main = "Project/Reject") {

    pch <- c(19, 21)
    col <- c("grey", col)

    ## Find the first node to separate nodes/tips
    root <- which(rownames(data$matrix[[1]]) == "n1")
    ## Split the plot data
    tips_block <- c(1:root-1)
    nodes_block <- c(root:nrow((data$matrix[[1]])))
    ## Split the colours and pch
    colours <- c(rep(col[1], length(nodes_block)),
                 rep(col[2], length(tips_block)))
    pchs <- c(rep(pch[1], length(nodes_block)),
              rep(pch[2], length(tips_block)))
    ## plot the results
    plot(results[c(nodes_block, tips_block), ], xlab = xlab, ylab = ylab, col = colours, pch = pchs, main = main)
}
plot.project.reject.log <- function(results, data, xlab = "Elaboration (log)", ylab = "Exploration (log)", col = "black", main = "Project/Reject") {

    plot.project.reject(log(results), data, xlab, ylab, col, main)
}

```


```{r, fig.height = 12, fig.width = 12}
## MRCA trajectory 
psita_results <- project.reject(tmp_simple_matrices$psita,
                                 vector = c("root", "ancestor"))
chara_results <- project.reject(tmp_simple_matrices$chara,
                                 vector = c("root", "ancestor"))

par(mfrow = c(2,2))
plot.project.reject(psita_results, tmp_simple_matrices$psita, col = "blue", main = "Psittaciformes - root/ancestor")
plot.project.reject(chara_results, tmp_simple_matrices$chara, col = "orange", main = "Charadriiformes - root/ancestor")
plot.project.reject.log(psita_results, tmp_simple_matrices$psita, col = "blue", main = "Psittaciformes - root/ancestor")
plot.project.reject.log(chara_results, tmp_simple_matrices$chara, col = "orange", main = "Charadriiformes - root/ancestor")
```

```{r, fig.height = 6, fig.width = 12}
## Centroid (tips) ancestor trajectory 
psita_results <- project.reject(tmp_simple_matrices$psita,
                                 vector = c("tips", "ancestor"))
chara_results <- project.reject(tmp_simple_matrices$chara,
                                 vector = c("tips", "ancestor"))

par(mfrow = c(1,2))
plot.project.reject.log(psita_results, tmp_simple_matrices$psita, col = "blue", main = "Psittaciformes - tips/ancestor")
plot.project.reject.log(chara_results, tmp_simple_matrices$chara, col = "orange", main = "Charadriiformes - tips/ancestor")
```

```{r, fig.height = 6, fig.width = 12}
## Centroid (nodes) ancestor trajectory 
psita_results <- project.reject(tmp_simple_matrices$psita,
                                 vector = c("nodes", "ancestor"))
chara_results <- project.reject(tmp_simple_matrices$chara,
                                 vector = c("nodes", "ancestor"))

par(mfrow = c(1,2))
plot.project.reject.log(psita_results, tmp_simple_matrices$psita, col = "blue", main = "Psittaciformes - nodes/ancestor")
plot.project.reject.log(chara_results, tmp_simple_matrices$chara, col = "orange", main = "Charadriiformes - nodes/ancestor")
```

```{r, fig.height = 6, fig.width = 12}
## Centroid (root) tips trajectory 
psita_results <- project.reject(tmp_simple_matrices$psita,
                                 vector = c("root", "tips"))
chara_results <- project.reject(tmp_simple_matrices$chara,
                                 vector = c("root", "tips"))

par(mfrow = c(1,2))
plot.project.reject.log(psita_results, tmp_simple_matrices$psita, col = "blue", main = "Psittaciformes - root/tips")
plot.project.reject.log(chara_results, tmp_simple_matrices$chara, col = "orange", main = "Charadriiformes - root/tips")
```


```{r, fig.height = 6, fig.width = 12}
## Centroid (tips) ancestor trajectory 
psita_results <- project.reject(tmp_simple_matrices$psita,
                                 vector = c("root", colMeans))
chara_results <- project.reject(tmp_simple_matrices$chara,
                                 vector = c("tips", "ancestor"))

par(mfrow = c(1,2))
plot.project.reject.log(psita_results, tmp_simple_matrices$psita, col = "blue", main = "Psittaciformes - tips/ancestor")
plot.project.reject.log(chara_results, tmp_simple_matrices$chara, col = "orange", main = "Charadriiformes - tips/ancestor")
```



## Elaboration/exploration in the present

Apply these metrics on both clades to get two scores for each taxa (elaboration vs. exploration plots).

Measure the exploration/elaboration for all clades in the whole bird trees and see which ones are particularly low/high?


## Elaboration/exploration through time

Do some time-slicing and run these metrics through time.



## Ideas for getting the axis of "elaboration"

```{r, fig.height = 8, fig.width = 8}
library(dads)

## Simulate a pure-bd tree with a BM trait
data <- dads(stop.rule = list(max.living = 300), bd.params = list(speciation = 2), traits = make.traits(n = 3))
plot(data, main = "One trait through time")

## The node ages
ages <- tree.age(data$tree)
node_ages <- ages[which(ages$elements %in% data$tree$node.label),]

## A model of trait through time [TODO: use some time regression or something line that]
# time_trait <- cbind(time = rev(node_ages$ages), trait = data$data[data$tree$node.label, ])
# model <- lm(data$data[data$tree$node.label,] ~ 0 + node_ages$ages)
arrows(y0 = 0, x0 = max(node_ages$ages), y1 = mean(data$data[data$tree$tip.label, ]), x1 = 0, lwd = 3)
```

```{r}
library(rgl)
open3d()
plot(data, trait = c(1:2), use.3D = TRUE)
time_trait_arrow <- matrix(NA, 2, 3)
time_trait_arrow[1,] <- c(max(node_ages$ages),
                          0,
                          0)
time_trait_arrow[2,] <- c(0,
                          mean(data$data[data$tree$tip.label, 1]),
                          mean(data$data[data$tree$tip.label, 2]))
segments3d(time_trait_arrow, lwd = 3)

## 3D version
open3d()
plot(data, trait = c(1,2,3), use.3D = TRUE)
data_trait_arrow <- matrix(NA, 2, 3)
data_trait_arrow[1,] <- c(0,
                          0,
                          0)
data_trait_arrow[2,] <- c(mean(data$data[data$tree$tip.label, 1]),
                          mean(data$data[data$tree$tip.label, 2]),
                          mean(data$data[data$tree$tip.label, 3]))
segments3d(data_trait_arrow, lwd = 3)

```